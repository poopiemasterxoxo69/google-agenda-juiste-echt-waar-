<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Agenda Tool</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f5f5f5;
      max-width: 700px;
      margin: auto;
      padding: 20px;
    }
    h1 { text-align: center; }
    textarea, select, button {
      width: 100%;
      margin-top: 10px;
      font-size: 16px;
      padding: 10px;
    }
    #kleur, #heleDagContainer, #duurContainer {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
<h1>Agenda Tool</h1>
<button onclick="handleAuthClick()">Log in met Google</button>
<p id="status">Niet ingelogd</p>
<textarea id="inputText" rows="6" placeholder="Bijv: kapper donderdag 15:00&#10;rijles&#10;maandag 14:00&#10;woensdag 14:00"></textarea>

<label for="kleur">Kies kleur:</label>
<select id="kleur">
  <option value="random" selected>🎲 Willekeurig</option>
  <option value="11">❤️ Rood</option><option value="6">🟧 Oranje</option>
  <option value="5">💛 Geel</option><option value="10">💚 Donkergroen</option>
  <option value="2">💚 Lichtgroen</option><option value="9">💙 Blauw</option>
  <option value="7">🫐 Bosbes</option><option value="3">💜 Lavendel</option>
  <option value="4">🍇 Paars</option><option value="1">💗 Roze</option>
  <option value="8">⚫ Grijs</option>
</select>

<div id="duurContainer">
  <label for="duur">Kies duur:</label>
  <select id="duur">
    <option value="30" selected>30 minuten</option>
    <option value="45">45 minuten</option>
    <option value="60">1 uur</option>
    <option value="90">1,5 uur</option>
  </select>
</div>

<div id="heleDagContainer">
  <label><input type="checkbox" id="heleDag"> Hele dag</label>
</div>

<button onclick="addMultipleEvents()">➕ Voeg toe aan agenda</button>

<script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
let tokenClient;
let accessToken = null;

function gapiLoaded() {
  gapi.load('client', initializeGapiClient);
}
async function initializeGapiClient() {
  await gapi.client.init({
    apiKey: '',
    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
  });
}
window.onload = () => {
  if (typeof google !== "undefined") {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: '424624995566-0aprf3c3739snsn0q752kj4slifditj3.apps.googleusercontent.com',
      scope: 'https://www.googleapis.com/auth/calendar.events.readonly https://www.googleapis.com/auth/calendar.events',
      callback: (tokenResponse) => {
        accessToken = tokenResponse.access_token;
        document.getElementById("status").innerText = "Ingelogd ✔";
      },
    });
  }
};
function handleAuthClick() {
  if (tokenClient) {
    tokenClient.requestAccessToken();
  } else {
    alert("Google auth is nog niet geladen.");
  }
}

function parseLineToEvents(title, lines, heleDag, duurMinuten) {
  const dagen = ["zondag","maandag","dinsdag","woensdag","donderdag","vrijdag","zaterdag"];
  const maanden = {
    januari:0,februari:1,maart:2,april:3,mei:4,juni:5,juli:6,
    augustus:7,september:8,oktober:9,november:10,december:11
  };
  const events = [];

  for (const line of lines) {
    if (!line.trim()) continue;

    let text = line.trim();
    let eventTitle = title;
    let date = new Date();

    const dagMatch = text.match(new RegExp(`(${dagen.join('|')})`, 'i'));
    const tijdMatch = text.match(/(\d{1,2}):(\d{2})/);
    const datumMatch = text.match(/(\d{1,2})[\/-](\d{1,2})(?:[\/-](\d{2,4}))?/);
    const maandMatch = text.match(/(\d{1,2})\s+(januari|februari|maart|april|mei|juni|juli|augustus|september|oktober|november|december)/i);

    if (!tijdMatch) continue;

    const hour = parseInt(tijdMatch[1]);
    const minute = parseInt(tijdMatch[2]);

    if (datumMatch) {
      const day = parseInt(datumMatch[1]);
      const month = parseInt(datumMatch[2]) - 1;
      const year = datumMatch[3] ? parseInt(datumMatch[3]) : new Date().getFullYear();
      date = new Date(year, month, day, hour, minute);
    } else if (maandMatch) {
      const day = parseInt(maandMatch[1]);
      const month = maanden[maandMatch[2].toLowerCase()];
      date = new Date(new Date().getFullYear(), month, day, hour, minute);
    } else if (dagMatch) {
      const vandaag = new Date();
      const vandaagDag = vandaag.getDay();
      const doelDag = dagen.indexOf(dagMatch[1].toLowerCase());
      const diff = (doelDag + 7 - vandaagDag) % 7 || 7;
      date = new Date(vandaag.getFullYear(), vandaag.getMonth(), vandaag.getDate() + diff, hour, minute);
    }

    const eind = new Date(date.getTime() + duurMinuten * 60000);

    if (heleDag) {
      events.push({
        summary: eventTitle,
        start: { date: date.toISOString().split('T')[0] },
        end: { date: new Date(date.getTime() + 24*60*60*1000).toISOString().split('T')[0] }
      });
    } else {
      events.push({
        summary: eventTitle,
        start: { dateTime: date.toISOString(), timeZone: 'Europe/Amsterdam' },
        end: { dateTime: eind.toISOString(), timeZone: 'Europe/Amsterdam' }
      });
    }
  }

  return events;
}

async function checkConflict(event) {
  const params = {
    calendarId: 'primary',
    timeMin: event.start.dateTime || (event.start.date + 'T00:00:00Z'),
    timeMax: event.end.dateTime || (event.end.date + 'T23:59:59Z'),
    singleEvents: true
  };
  const response = await gapi.client.calendar.events.list(params);
  return response.result.items;
}

async function addEvent(event, kleurId) {
  event.colorId = kleurId;
  try {
    const conflicts = await checkConflict(event);
    if (conflicts.length > 0) {
      const existing = conflicts[0];
      const tijd = new Date(existing.start.dateTime || existing.start.date).toLocaleString();
      const titel = existing.summary || "Naamloos";
      const doorgaan = confirm(`Let op: er staat al '${titel}' op ${tijd}. Toch toevoegen?`);
      if (!doorgaan) return;
    }
    await gapi.client.calendar.events.insert({
      calendarId: 'primary',
      resource: event
    }).execute();
  } catch (error) {
    console.error(error);
    alert("Fout bij toevoegen van event.");
  }
}

async function addMultipleEvents() {
  if (!accessToken) {
    alert("Log eerst in met Google.");
    return;
  }
  const heleDag = document.getElementById("heleDag").checked;
  const kleurSelect = document.getElementById("kleur");
  const gekozenKleur = kleurSelect.value === "random"
    ? ["1","2","3","4","5","6","7","8","9","10","11"][Math.floor(Math.random()*11)]
    : kleurSelect.value;

  const duurMin = parseInt(document.getElementById("duur").value);
  const lines = document.getElementById("inputText").value.split("\n");

  let titel = "", verzameldeRegels = [];

  for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed) continue;

    if (trimmed.match(/^\D+$/)) {
      if (titel && verzameldeRegels.length > 0) {
        const events = parseLineToEvents(titel, verzameldeRegels, heleDag, duurMin);
        for (const ev of events) await addEvent(ev, gekozenKleur);
      }
      titel = trimmed;
      verzameldeRegels = [];
    } else {
      verzameldeRegels.push(trimmed);
    }
  }

  if (titel && verzameldeRegels.length > 0) {
    const events = parseLineToEvents(titel, verzameldeRegels, heleDag, duurMin);
    for (const ev of events) await addEvent(ev, gekozenKleur);
  }

  alert("Klaar! Alles is toegevoegd.");
}
</script>
</body>
</html>
