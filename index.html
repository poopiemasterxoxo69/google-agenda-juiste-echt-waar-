
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Agenda Tool met Parser</title>
  <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>

  <script>
    let tokenClient;
    let accessToken = null;

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: '',
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
      });
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: '424624995566-0aprf3c3739snsn0q752kj4slifditj3.apps.googleusercontent.com',
        scope: 'https://www.googleapis.com/auth/calendar.events',
        callback: (tokenResponse) => {
          accessToken = tokenResponse.access_token;
          document.getElementById("status").innerText = "Ingelogd âœ”";
        },
      });
    }

    function handleAuthClick() {
      tokenClient.requestAccessToken();
    }

    // Parser: zet tekst zoals "kapper maandag 14:00" om naar een event object
    function parseTextToEvent(text) {
      const dagen = {
        'maandag': 1,
        'dinsdag': 2,
        'woensdag': 3,
        'donderdag': 4,
        'vrijdag': 5,
        'zaterdag': 6,
        'zondag': 0
      };

      let foundDay = null;
      for (let dag in dagen) {
        if (text.toLowerCase().includes(dag)) {
          foundDay = dagen[dag];
          break;
        }
      }
      if (foundDay === null) {
        alert("Geen geldige dag gevonden in de tekst.");
        return null;
      }

      const timeMatch = text.match(/(\d{1,2}):(\d{2})/);
      if (!timeMatch) {
        alert("Geen tijd gevonden in de tekst.");
        return null;
      }

      const hour = parseInt(timeMatch[1]);
      const minute = parseInt(timeMatch[2]);

      // Bepaal volgende datum voor die dag
      const now = new Date();
      const resultDate = new Date(now);
      resultDate.setDate(now.getDate() + ((7 + foundDay - now.getDay()) % 7 || 7));
      resultDate.setHours(hour, minute, 0, 0);

      const endDate = new Date(resultDate.getTime() + 60 * 60 * 1000);

      return {
        summary: text,
        start: {
          dateTime: resultDate.toISOString(),
          timeZone: 'Europe/Amsterdam',
        },
        end: {
          dateTime: endDate.toISOString(),
          timeZone: 'Europe/Amsterdam',
        },
      };
    }

    async function addEvent() {
      if (!accessToken) {
        alert("Log eerst in met Google.");
        return;
      }
      const text = document.getElementById("inputText").value;
      const event = parseTextToEvent(text);
      if (!event) return;

      try {
        const request = gapi.client.calendar.events.insert({
          calendarId: 'primary',
          resource: event,
        });
        await request.execute();
        alert("Event toegevoegd!");
      } catch (error) {
        console.error(error);
        alert("Fout bij toevoegen van event.");
      }
    }
  </script>
</head>
<body onload="gapiLoaded();">
  <h1>Agenda Tooool (met Parser)</h1>
  <button onclick="handleAuthClick()">Log in met Google</button>
  <p id="status">Niet ingelogd</p>
  <textarea id="inputText" rows="4" cols="50" placeholder="Bijv: kapper maandag 14:00"></textarea><br>
  <button onclick="addEvent()">Voeg toe aan agenda</button>

  <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>
  <script onload="gisLoaded()" async defer></script>
</body>
</html>
