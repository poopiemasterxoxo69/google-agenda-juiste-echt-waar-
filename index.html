<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Evenementen Parser - Parse & Log (Verbeterd)</title>
  <style>
    body { font-family: Arial, sans-serif; }
    #result table, .log-entry table { border-collapse: collapse; margin-top: 10px; }
    #result th, #result td, .log-entry th, .log-entry td { border: 1px solid #ccc; padding: 8px 12px; }
    #result th, .log-entry th { background: #f0f0f0; }
    .log-entry { margin-top: 30px; border-top: 2px solid #888; padding-top: 10px; }
    .log-label { font-weight: bold; color: #444; margin-bottom: 5px; }
  </style>
</head>
<body>
  <h2>Evenementen invoer</h2>
  <textarea id="eventInput" rows="4" cols="80">zondag ochtend werk 12:00</textarea><br>
  <label>Kleur: <input type="text" id="color" value="random"></label>
  <label>Duur: <input type="text" id="duration" value="1 uur"></label>
  <button id="parseAndLogBtn">Parse &amp; Log</button>
  <div id="result"></div>
  <h3>Log</h3>
  <div id="log"></div>
  <script>
    // --- Configuratie ---
    const maandnamen = ["januari","februari","maart","april","mei","juni","juli","augustus","september","oktober","november","december"];
    const dagen = ["maandag","dinsdag","woensdag","donderdag","vrijdag","zaterdag","zondag"];
    const maandSet = new Set(maandnamen);

    document.getElementById("parseAndLogBtn").addEventListener("click", () => {
      parseAndLog();
    });

    function parseAndLog() {
      const inputRaw = document.getElementById("eventInput").value.trim();
      const color = document.getElementById("color").value;
      const duration = document.getElementById("duration").value;
      const events = parseEvents(inputRaw, color, duration);
      showEvents(events);
      logResult(inputRaw, events);
    }

    function showEvents(events) {
      const resultDiv = document.getElementById("result");
      if (events.length === 0) {
        resultDiv.innerHTML = "<p>Geen evenementen gevonden.</p>";
        return;
      }
      resultDiv.innerHTML = eventTableHtml(events);
    }

    function logResult(inputRaw, events) {
      const logDiv = document.getElementById("log");
      const entry = document.createElement("div");
      entry.classList.add("log-entry");
      entry.innerHTML = `
        <div class="log-label">Input:</div>
        <div style="margin-bottom:8px;white-space:pre-line;">${escapeHtml(inputRaw)}</div>
        <div class="log-label">Resultaat:</div>
        ${events.length === 0 ? "<em>Geen evenementen gevonden.</em>" : eventTableHtml(events)}
      `;
      logDiv.appendChild(entry);
    }

    function eventTableHtml(events) {
      let html = '<table><tr><th>Titel</th><th>Datum</th><th>Tijd</th><th>Duur</th><th>Kleur</th></tr>';
      for (const ev of events) {
        html += `<tr>
          <td>${ev.titel}</td>
          <td>${ev.datum}</td>
          <td>${ev.tijd}</td>
          <td>${ev.duur}</td>
          <td>${ev.kleur}</td>
        </tr>`;
      }
      html += '</table>';
      return html;
    }

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, function(m) {
        return ({
          '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        })[m];
      });
    }

    // --- Verbeterde parser ---
    function parseEvents(input, kleur, duur) {
      let clauses = input.split(/,|\n/).map(c => c.trim()).filter(Boolean);
      let events = [];
      for (let clause of clauses) {
        let {dag, dagIndex, dagPos} = matchDay(clause);
        let explicitDate = matchExplicitDate(clause);
        let relDate = matchRelativeDate(clause);
        let dateObj = explicitDate ? explicitDate.date : (relDate ? relDate.date : null);
        let dateDesc = explicitDate ? explicitDate.label : (relDate ? relDate.label : null);

        // Alle tijden in de zin, gesorteerd op positie
        let tijden = matchAllTimes(clause);

        // Als er tijden zijn, splits zin in blokken per tijd, koppel aan bijbehorende titel
        if (tijden.length > 0) {
          for (let i=0; i<tijden.length; ++i) {
            let tijd = tijden[i].tijd;
            let tijdPos = tijden[i].pos;
            let tijdLen = tijden[i].len;
            // Titel is: alles tussen deze tijd en de volgende, split op "en", neem per tijd één titel (de eerste niet-lege)
            let after = clause.substring(tijdPos + tijdLen, i+1<tijden.length?tijden[i+1].pos:clause.length);
            let titels = after.split(/\ben\b/i).map(cleanTitle).filter(Boolean);
            let titel = titels[0] || cleanTitle(clause.substring(0, tijdPos)); // fallback: alles vóór tijd
            if (!titel) titel = "Evenement";
            let datum = getDatum(dag, dagIndex, dateObj, dateDesc);
            events.push({ titel, datum, tijd, duur, kleur });
          }
        } else {
          // Geen tijd, zoek contexttijd
          let tijd = matchContextTime(clause) || "Hele dag";
          let titel = cleanTitle(clause.replace(/^\b(\w+)\b/, "")); // verwijder dagnaam aan begin
          if (!titel) titel = "Evenement";
          let datum = getDatum(dag, dagIndex, dateObj, dateDesc);
          events.push({ titel, datum, tijd, duur, kleur });
        }
      }
      return events;
    }

    function cleanTitle(titel) {
      return titel
        .replace(/^\s*(om|tot|en|daarna)?\s*/gi, "")
        .replace(/[\.,;:]+$/, "")
        .replace(/^\d{1,2}[:\.]\d{2}$/, "")
        .replace(/^\d{1,2}(\s*u|uur)?$/, "")
        .replace(/\bochtend\b|\bmiddag\b|\bavond\b|\bmiddernacht\b/gi, "")
        .trim();
    }

    function matchDay(str) {
      for (let i=0; i<dagen.length; ++i) {
        const d = dagen[i];
        const r = new RegExp(`\\b${d}\\b`, 'i');
        const m = r.exec(str);
        if (m) return { dag: d, dagIndex: i, dagPos: m.index };
      }
      return { dag: null, dagIndex: -1, dagPos: -1 };
    }

    function matchExplicitDate(str) {
      let m = str.match(/\b(\d{1,2})\s*([a-z]+)(?:\s+(\d{4}))?\b/i);
      if (m && maandSet.has(m[2].toLowerCase())) {
        let dag = parseInt(m[1]);
        let maand = maandnamen.indexOf(m[2].toLowerCase());
        let jaar = m[3] ? parseInt(m[3]) : (new Date()).getFullYear();
        let dt = new Date(jaar, maand, dag);
        return { date: dt, label: `${dag} ${maandnamen[maand]} ${jaar}` };
      }
      m = str.match(/\b(\d{1,2})[/-](\d{1,2})[/-](\d{2,4})\b/);
      if (m) {
        let dag = parseInt(m[1]);
        let maand = parseInt(m[2]) - 1;
        let jaar = parseInt(m[3]); if (jaar < 100) jaar += 2000;
        let dt = new Date(jaar, maand, dag);
        return { date: dt, label: `${dag} ${maandnamen[maand]} ${jaar}` };
      }
      return null;
    }

    function matchRelativeDate(str) {
      let nu = new Date();
      if (str.match(/\bovermorgen\b/i)) {
        let dt = new Date(nu); dt.setDate(dt.getDate()+2);
        return { date: dt, label: `${dt.getDate()} ${maandnamen[dt.getMonth()]} ${dt.getFullYear()}` };
      }
      if (str.match(/\bmorgen\b/i)) {
        let dt = new Date(nu); dt.setDate(dt.getDate()+1);
        return { date: dt, label: `${dt.getDate()} ${maandnamen[dt.getMonth()]} ${dt.getFullYear()}` };
      }
      if (str.match(/\bvandaag\b/i)) {
        let dt = new Date(nu);
        return { date: dt, label: `${dt.getDate()} ${maandnamen[dt.getMonth()]} ${dt.getFullYear()}` };
      }
      if (str.match(/\bgisteren\b/i)) {
        let dt = new Date(nu); dt.setDate(dt.getDate()-1);
        return { date: dt, label: `${dt.getDate()} ${maandnamen[dt.getMonth()]} ${dt.getFullYear()}` };
      }
      let weken = str.match(/\bover\s+(\d+)\s+weken?\b/i);
      if (weken) {
        let n = parseInt(weken[1]);
        let dt = new Date(nu); dt.setDate(dt.getDate()+n*7);
        return { date: dt, label: `${dt.getDate()} ${maandnamen[dt.getMonth()]} ${dt.getFullYear()}` };
      }
      let dagenMatch = str.match(/\bover\s+(\d+)\s+dagen?\b/i);
      if (dagenMatch) {
        let n = parseInt(dagenMatch[1]);
        let dt = new Date(nu); dt.setDate(dt.getDate()+n);
        return { date: dt, label: `${dt.getDate()} ${maandnamen[dt.getMonth()]} ${dt.getFullYear()}` };
      }
      return null;
    }

    function matchAllTimes(str) {
      // Herkent ook "half drie", "kwart over tien", etc.
      let tijden = [];
      // 1. Speciaal: kwart/half/voor/over
      let specials = [
        [/\bkwart over (\d{1,2})/i, (m) => ({ h: parseInt(m[1]), m: 15 })],
        [/\bkwart voor (\d{1,2})/i, (m) => ({ h: parseInt(m[1])-1, m: 45 })],
        [/\bhalf (\d{1,2})/i, (m) => ({ h: parseInt(m[1])-1, m: 30 })],
        [/\b(\d{1,2})\s*uur\b/i, (m) => ({ h: parseInt(m[1]), m: 0 })],
        [/\b(\d{1,2})[:\.](\d{2})/g, (m) => ({ h: parseInt(m[1]), m: parseInt(m[2]) })],
        [/\b(\d{1,2})\s*over\s*half\s*(\d{1,2})/i, (m) => ({ h: parseInt(m[2])-1, m: 30+parseInt(m[1]) })],
        [/\b(\d{1,2})\s*voor\s*half\s*(\d{1,2})/i, (m) => ({ h: parseInt(m[2])-1, m: 30-parseInt(m[1]) })],
        [/\b(\d{1,2})\s*over\s*kwart\s*(\d{1,2})/i, (m) => ({ h: parseInt(m[2])-1, m: 15+parseInt(m[1]) })],
        [/\b(\d{1,2})\s*voor\s*kwart\s*(\d{1,2})/i, (m) => ({ h: parseInt(m[2])-1, m: 15-parseInt(m[1]) })]
      ];
      for (let [regex, fn] of specials) {
        let m;
        while ((m = regex.exec(str)) !== null) {
          let {h, m:mi} = fn(m);
          if (h<0) h+=24;
          let tijd = `${String(h).padStart(2,"0")}:${String(mi).padStart(2,"0")}`;
          tijden.push({ tijd, pos: m.index, len: m[0].length });
        }
      }
      // 2. context "middernacht", "middag", enz.
      let ctx = [
        [/middernacht/i, "00:00"],
        [/ochtend/i, "09:00"],
        [/middag/i, "12:00"],
        [/avond/i, "19:00"],
      ];
      for (let [regex, t] of ctx) {
        let m = regex.exec(str);
        if (m) tijden.push({ tijd: t, pos: m.index, len: m[0].length });
      }
      // 3. gewone tijden als "13:00"
      let m;
      let re = /\b(\d{1,2}):(\d{2})/g;
      while ((m = re.exec(str)) !== null) {
        let tijd = `${String(parseInt(m[1])).padStart(2,"0")}:${String(parseInt(m[2])).padStart(2,"0")}`;
        tijden.push({ tijd, pos: m.index, len: m[0].length });
      }
      return tijden.sort((a,b)=>a.pos-b.pos);
    }

    function matchContextTime(str) {
      if (str.match(/\bmiddernacht\b/i)) return "00:00";
      if (str.match(/\bmiddag\b/i)) return "12:00";
      if (str.match(/\bochtend\b/i)) return "09:00";
      if (str.match(/\bavond\b/i)) return "19:00";
      return null;
    }

    function getDatum(dag, dagIndex, explicit, dateDesc) {
      if (explicit) {
        return `${explicit.getDate()} ${maandnamen[explicit.getMonth()]} ${explicit.getFullYear()}`;
      }
      if (dateDesc) return dateDesc;
      if (dag && dagIndex >= 0) {
        return volgendeDatumVoorDag(dagIndex);
      }
      return "Onbekend";
    }

    function volgendeDatumVoorDag(dagIndex) {
      // dagIndex: 0=maandag .. 6=zondag
      const vandaag = new Date();
      // JS: 0=zondag ... 6=zaterdag
      let vandaagJS = vandaag.getDay(); // 0=zo,1=ma,...
      // dagIndex 6=zondag->0, anders +1
      let doelDagJS = (dagIndex === 6) ? 0 : dagIndex + 1;
      let diff = (doelDagJS - vandaagJS + 7) % 7;
      if (diff === 0) diff = 7;
      const nieuweDatum = new Date(vandaag);
      nieuweDatum.setDate(vandaag.getDate() + diff);
      return `${nieuweDatum.getDate()} ${maandnamen[nieuweDatum.getMonth()]} ${nieuweDatum.getFullYear()}`;
    }
  </script>
</body>
</html>