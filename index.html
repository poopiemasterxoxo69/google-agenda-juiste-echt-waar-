<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Agenda Tool met Kleuren</title>
<style>
  body {
    font-family: sans-serif;
    background-color: #f5f5f5;
    max-width: 700px;
    margin: auto;
    padding: 20px;
  }
  h1 {
    text-align: center;
  }
  textarea, select, button {
    width: 100%;
    margin-top: 10px;
    font-size: 16px;
    padding: 10px;
  }
  #kleur {
    margin-bottom: 20px;
  }
  label {
    font-weight: bold;
  }
</style>
</head>
<body>
<h1>Agenda Tool</h1>

<button onclick="handleAuthClick()">Log in met Google</button>
<p id="status">Niet ingelogd</p>

<textarea id="inputText" rows="4" placeholder="Bijv: kapper 5 juli 14:00 of vergadering om half 4 op 5/7"></textarea>

<label for="kleur">Kies kleur:</label>
<select id="kleur">
  <option value="random" selected>🎲 Willekeurig</option>
  <option value="11">❤️ Rood</option>
  <option value="6">🟧 Oranje</option>
  <option value="5">💛 Geel</option>
  <option value="10">💚 Donkergroen</option>
  <option value="2">💚 Lichtgroen</option>
  <option value="9">💙 Blauw</option>
  <option value="7">🫐 Bosbes</option>
  <option value="3">💜 Lavendel</option>
  <option value="4">🍇 Paars</option>
  <option value="1">💗 Roze</option>
  <option value="8">⚫ Grijs</option>
</select>

<label><input type="checkbox" id="heleDag"> Hele dag</label>

<button onclick="addEvent()">➕ Voeg toe aan agenda</button>

<script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
let tokenClient;
let accessToken = null;

function gapiLoaded() {
  gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
  await gapi.client.init({
    apiKey: '',
    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
  });
}

window.onload = () => {
  if (typeof google !== "undefined") {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: 'YOUR_CLIENT_ID',
      scope: 'https://www.googleapis.com/auth/calendar.events',
      callback: (tokenResponse) => {
        accessToken = tokenResponse.access_token;
        document.getElementById("status").innerText = "Ingelogd ✔";
      },
    });
  }
};

function handleAuthClick() {
  if (tokenClient) {
    tokenClient.requestAccessToken();
  } else {
    alert("Google auth is nog niet geladen.");
  }
}

function parseTimeString(text) {
  text = text.toLowerCase();

  let direct = text.match(/(\d{1,2})[:;.](\d{2})/);
  if (direct) return { hour: +direct[1], minute: +direct[2] };

  let uur = text.match(/\b(\d{1,2})\s*(uur|u)\b/);
  if (uur) return { hour: +uur[1], minute: 0 };

  let half = text.match(/\bhal[vf]?\s+(\d{1,2})\b/);
  if (half) return { hour: +half[1]-1, minute: 30 };

  let kwartOver = text.match(/\bkwart\s+over\s+(\d{1,2})\b/);
  if (kwartOver) return { hour: +kwartOver[1], minute: 15 };

  let kwartVoor = text.match(/\bkwart\s+voor\s+(\d{1,2})\b/);
  if (kwartVoor) return { hour: (+kwartVoor[1]+11)%12, minute: 45 };

  return null;
}

function parseTextToEvent(text) {
  const heleDag = document.getElementById("heleDag").checked;

  const datumMatch = text.match(/(\d{1,2})[\/-](\d{1,2})(?:[\/-](\d{2,4}))?|\b(\d{1,2})\s+(januari|februari|maart|april|mei|juni|juli|augustus|september|oktober|november|december)\b/i);
  if (!datumMatch) {
    alert("Je hebt geen datum vermeld.");
    return null;
  }

  let datum = new Date();
  if (datumMatch[1] && datumMatch[2]) {
    datum = new Date(datumMatch[3] || datum.getFullYear(), datumMatch[2]-1, datumMatch[1]);
  } else if (datumMatch[4] && datumMatch[5]) {
    const maanden = {januari:0,februari:1,maart:2,april:3,mei:4,juni:5,juli:6,augustus:7,september:8,oktober:9,november:10,december:11};
    datum = new Date(datum.getFullYear(), maanden[datumMatch[5].toLowerCase()], datumMatch[4]);
  }

  const tijd = parseTimeString(text);
  if (!heleDag && !tijd) {
    alert("Je hebt geen tijd vermeld.");
    return null;
  }

  const title = text.split(/\d/)[0].trim() || "Gebeurtenis";

  if (heleDag) {
    return {
      summary: title,
      start: { date: datum.toISOString().split("T")[0] },
      end: { date: new Date(datum.getTime() + 86400000).toISOString().split("T")[0] }
    };
  } else {
    datum.setHours(tijd.hour, tijd.minute, 0, 0);
    const startDate = new Date(datum);
    const endDate = new Date(startDate.getTime() + 30*60000);
    return {
      summary: title,
      start: { dateTime: startDate.toISOString(), timeZone: 'Europe/Amsterdam' },
      end: { dateTime: endDate.toISOString(), timeZone: 'Europe/Amsterdam' }
    };
  }
}

async function checkConflict(event) {
  const start = event.start.dateTime || (event.start.date + "T00:00:00Z");
  const end = event.end.dateTime || (event.end.date + "T23:59:59Z");

  const res = await gapi.client.calendar.events.list({
    calendarId: 'primary',
    timeMin: start,
    timeMax: end,
    singleEvents: true,
    orderBy: 'startTime'
  });

  const conflicting = res.result.items.find(e => {
    const eStart = new Date(e.start.dateTime || e.start.date);
    const eEnd = new Date(e.end.dateTime || e.end.date);
    const newStart = new Date(start);
    const newEnd = new Date(end);
    return Math.abs(eStart - newStart) < 30*60000 || Math.abs(eEnd - newStart) < 30*60000;
  });

  if (conflicting) {
    const when = conflicting.start.dateTime || conflicting.start.date;
    const tijd = new Date(when).toLocaleTimeString("nl-NL", { hour: '2-digit', minute: '2-digit' });
    alert(`Er is al iets gepland op dat tijdstip: ${conflicting.summary} (${tijd})`);
    return true;
  }

  return false;
}

async function addEvent() {
  if (!accessToken) {
    alert("Log eerst in met Google.");
    return;
  }

  const kleuren = ["1","2","3","4","5","6","7","8","9","10","11"];
  const kleurSelect = document.getElementById("kleur");
  const gekozen = kleurSelect.value === "random" ? kleuren[Math.floor(Math.random()*kleuren.length)] : kleurSelect.value;

  const text = document.getElementById("inputText").value.trim();
  const event = parseTextToEvent(text);
  if (!event) return;

  event.colorId = gekozen;

  const conflict = await checkConflict(event);
  if (conflict) return;

  try {
    await gapi.client.calendar.events.insert({ calendarId: 'primary', resource: event });
    alert("Event toegevoegd!");
  } catch (err) {
    console.error(err);
    alert("Fout bij toevoegen van event.");
  }
}
</script>

</body>
</html>
