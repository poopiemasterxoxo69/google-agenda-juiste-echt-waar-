
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Agenda Tool met Consensus</title>
<style>
body { font-family: sans-serif; background-color: #f5f5f5; max-width: 700px; margin: auto; padding: 20px; }
h1 { text-align: center; }
textarea, select, button { width: 100%; margin-top: 10px; font-size: 16px; padding: 10px; }
#kleur { margin-bottom: 20px; }
label { font-weight: bold; }
</style>
</head>
<body>
<h1>Agenda Tool</h1>
<button onclick="handleAuthClick()">Log in met Google</button>
<p id="status">Niet ingelogd</p>

<textarea id="inputText" rows="4" placeholder="Bijv: kapper maandag 14:00 of vergadering 5 juli 10:00-11:00"></textarea>

<label for="kleur">Kies kleur:</label>
<select id="kleur">
<option value="random" selected>🎲 Willekeurig</option>
<option value="11">❤️ Rood</option>
<option value="6">🟧 Oranje</option>
<option value="5">💛 Geel</option>
<option value="10">💚 Donkergroen</option>
<option value="2">💚 Lichtgroen</option>
<option value="9">💙 Blauw</option>
<option value="3">💜 Lavendel</option>
<option value="4">🍇 Paars</option>
<option value="1">💗 Roze</option>
<option value="8">⚫ Grijs</option>
</select>

<label><input type="checkbox" id="heleDag"> Hele dag</label>

<button onclick="addEvent()">➕ Voeg toe aan agenda</button>

<script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
let tokenClient;
let accessToken = null;

function gapiLoaded() {
  gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
  await gapi.client.init({
    apiKey: '',
    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
  });
}

window.onload = () => {
  if (typeof google !== "undefined") {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: '424624995566-0aprf3c3739snsn0q752kj4slifditj3.apps.googleusercontent.com',
      scope: 'https://www.googleapis.com/auth/calendar.events',
      callback: (tokenResponse) => {
        accessToken = tokenResponse.access_token;
        document.getElementById("status").innerText = "Ingelogd ✔";
      },
    });
  }
};

function handleAuthClick() {
  if (tokenClient) tokenClient.requestAccessToken();
  else alert("Google auth is nog niet geladen.");
}

function parseTextToEvent(text) {
  const tijd = text.match(/(\d{1,2}):(\d{2})(?:\s*(?:tot|\-|–)\s*(\d{1,2}):(\d{2}))?/);
  let startH = 0, startM = 0, endH = null, endM = null;
  if (tijd) {
    startH = parseInt(tijd[1]);
    startM = parseInt(tijd[2]);
    if (tijd[3]) endH = parseInt(tijd[3]);
    if (tijd[4]) endM = parseInt(tijd[4]);
  }
  let datum = new Date();
  const day = datum.getDate(), month = datum.getMonth(), year = datum.getFullYear();
  datum.setHours(startH, startM, 0, 0);
  const endDate = endH !== null ? new Date(year, month, day, endH, endM || 0) : new Date(datum.getTime() + 30*60000);
  return {
    summary: text.split(/\d{1,2}[:\/]/)[0].trim() || "Gebeurtenis",
    start: { dateTime: datum.toISOString(), timeZone: 'Europe/Amsterdam' },
    end: { dateTime: endDate.toISOString(), timeZone: 'Europe/Amsterdam' }
  };
}

async function getConsensus(text) {
  const aiUrls = [
    "https://google-agenda-juiste-echt-waar.vercel.app/api/parse-groq",
    "https://google-agenda-juiste-echt-waar.vercel.app/api/parse-hf"
  ];
  const jsParsed = parseTextToEvent(text);
  const aiResults = await Promise.all(aiUrls.map(async url => {
    try {
      const res = await fetch(url, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tekst: text })
      });
      return await res.json();
    } catch { return null; }
  }));

  const all = [jsParsed, ...aiResults].filter(x => x);
  const map = new Map();
  all.forEach(ev => {
    const key = `${ev.summary}-${ev.start.dateTime||ev.start.date}`;
    map.set(key, (map.get(key)||0)+1);
  });
  for (let [key, count] of map.entries()) {
    if (count >=2) {
      return all.find(ev => key.startsWith(ev.summary));
    }
  }
  return null;
}

async function checkConflict(event) {
  const start = event.start.dateTime || (event.start.date + "T00:00:00Z");
  const end = event.end.dateTime || (event.end.date + "T23:59:59Z");
  const res = await gapi.client.calendar.events.list({
    calendarId: 'primary',
    timeMin: start,
    timeMax: end,
    singleEvents: true,
    orderBy: 'startTime'
  });
  return res.result.items.length > 0;
}

async function addEvent() {
  if (!accessToken) { alert("Log eerst in met Google."); return; }
  const text = document.getElementById("inputText").value;
  const gekozen = document.getElementById("kleur").value;

  const event = await getConsensus(text);
  if (!event) { alert("Geen consensus tussen de modellen."); return; }
  event.colorId = gekozen==="random"?String(Math.floor(Math.random()*11)+1):gekozen;

  const conflict = await checkConflict(event);
  if (conflict && !confirm("Er is al iets gepland op deze tijd. Toch toevoegen?")) return;

  try {
    const request = gapi.client.calendar.events.insert({
      calendarId: 'primary', resource: event
    });
    await request.execute();
    alert("Event toegevoegd!");
  } catch (error) {
    console.error(error);
    alert("Fout bij toevoegen van event.");
  }
}
</script>
</body>
</html>
