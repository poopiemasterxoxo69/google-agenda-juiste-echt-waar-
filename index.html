<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Agenda Tool met Kleuren</title>
<style>
body {
  font-family: sans-serif;
  background-color: #f5f5f5;
  max-width: 700px;
  margin: auto;
  padding: 20px;
}
h1 { text-align: center; }
textarea, select, button {
  width: 100%;
  margin-top: 10px;
  font-size: 16px;
  padding: 10px;
}
#kleur { margin-bottom: 20px; }
label { font-weight: bold; }
</style>
</head>
<body>
<h1>Agenda Tool</h1>
<button onclick="handleAuthClick()">Log in met Google</button>
<p id="status">Niet ingelogd</p>
<textarea id="inputText" rows="4" placeholder="Bijv: kapper 5 juli om half 4 of vergadering 6 juli 14:00"></textarea>

<label for="kleur">Kies kleur:</label>
<select id="kleur">
<option value="random" selected>🎲 Willekeurig</option>
<option value="11">❤️ Rood</option>
<option value="6">🟧 Oranje</option>
<option value="5">💛 Geel</option>
<option value="10">💚 Donkergroen</option>
<option value="2">💚 Lichtgroen</option>
<option value="9">💙 Blauw</option>
<option value="7">🫐 Bosbes</option>
<option value="3">💜 Lavendel</option>
<option value="4">🍇 Paars</option>
<option value="1">💗 Roze</option>
<option value="8">⚫ Grijs</option>
</select>

<label><input type="checkbox" id="heleDag"> Hele dag</label>

<button onclick="addEvent()">➕ Voeg toe aan agenda</button>

<script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
let tokenClient;
let accessToken = null;

function gapiLoaded() {
  gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
  await gapi.client.init({
    apiKey: '',
    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
  });
}

window.onload = () => {
  if (typeof google !== "undefined") {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: '424624995566-0aprf3c3739snsn0q752kj4slifditj3.apps.googleusercontent.com',
      scope: 'https://www.googleapis.com/auth/calendar.events.readonly https://www.googleapis.com/auth/calendar.events',
      callback: (tokenResponse) => {
        accessToken = tokenResponse.access_token;
        document.getElementById("status").innerText = "Ingelogd ✔";
      },
    });
  }
};

function handleAuthClick() {
  if (tokenClient) {
    tokenClient.requestAccessToken();
  } else {
    alert("Google auth is nog niet geladen.");
  }
}

function parseTextToEvent(text) {
  const heleDag = document.getElementById("heleDag").checked;
  text = text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

  const title = text.split(/\d{1,2}[:;]/)[0].split("om")[0].trim() || "Gebeurtenis";

  const monthMap = {
    januari:0, februari:1, maart:2, april:3, mei:4, juni:5, juli:6,
    augustus:7, september:8, oktober:9, november:10, december:11
  };

  const datum = (() => {
  const today = new Date();
  today.setHours(0,0,0,0);

  const dateMatch = text.match(/(\d{1,2})\s*(j[a-z]+)/i);
  if (dateMatch) {
    const day = parseInt(dateMatch[1]);
    const maandTekst = dateMatch[2].toLowerCase();

    let maandIndex = null;

    if (monthMap.hasOwnProperty(maandTekst)) {
      maandIndex = monthMap[maandTekst];
    } else {
      let beste = null, besteAfstand = Infinity;
      for (const m of Object.keys(monthMap)) {
        const afstand = levenshtein(m, maandTekst);
        if (afstand < besteAfstand) {
          besteAfstand = afstand;
          beste = m;
        }
      }
      if (beste && besteAfstand <= 2) {
        maandIndex = monthMap[beste];
      }
    }

    if (maandIndex !== null) {
      let jaar = today.getFullYear();
      const kandidaat = new Date(jaar, maandIndex, day);
      if (kandidaat < today) {
        kandidaat.setFullYear(jaar + 1);
      }
      return kandidaat;
    }
  }

  return new Date();
})();

  const tijd = (() => {
  let hint = '';
  if (text.includes("ochtend")) hint = "ochtend";
  if (text.includes("middag")) hint = "middag";
  if (text.includes("avond")) hint = "avond";
  if (text.includes("nacht")) hint = "nacht";

  console.log(`hint gedetecteerd: ${hint || '(geen hint)'}`);

  const hhmm = text.match(/(\d{1,2})[:;\s](\d{2})/);
  if (hhmm) {
    let h = parseInt(hhmm[1]), m = parseInt(hhmm[2]);
    console.log(`hh:mm patroon gevonden: ${h}:${m}`);
    return {h, m};
  }

  const uurMatch = text.match(/(\d{1,2})/);
  if (!uurMatch) {
    console.log(`geen tijd gevonden`);
    return null;
  }

  let uur = parseInt(uurMatch[1]);
  let min = 0;

  const modifier = detecteerTijdModifier(text);
  console.log(`gedetecteerde modifier: ${modifier || '(geen)'}, uur=${uur}`);

  if (modifier === 'half') {
    uur -= 1;
    min = 30;
    console.log(`modifier=half → uur=${uur}, min=${min}`);
  } else if (modifier === 'kwart over') {
    min = 15;
    console.log(`modifier=kwart over → uur=${uur}, min=${min}`);
  } else if (modifier === 'kwart voor') {
    uur -= 1;
    min = 45;
    console.log(`modifier=kwart voor → uur=${uur}, min=${min}`);
  }

  if (uur <= 0) uur += 12;

  if (hint === "ochtend" && uur >= 12) {
    uur -= 12;
    console.log(`hint=ochtend, corrigeer naar ${uur}`);
  } else if ((hint === "middag" || hint === "avond") && uur < 12) {
    uur += 12;
    console.log(`hint=${hint}, corrigeer naar ${uur}`);
  } else if (!hint && uur < 8) {
    uur += 12;
    console.log(`geen hint & uur<8 → middag: ${uur}`);
  }

  console.log(`definitieve tijd: ${uur}:${min}`);
  return {h: uur, m: min};
})();





  if (!heleDag && !tijd) {
    alert("Kon geen geldige tijd vinden. Gebruik hh:mm of tekst als 'half 4' of 'half 4 ochtend'");
    return null;
  }

  if (heleDag) {
    const startDate = datum.toISOString().split("T")[0];
    const endDate = new Date(datum.getTime() + 24 * 60 * 60 * 1000).toISOString().split("T")[0];
    return {
      summary: title,
      start: { date: startDate },
      end: { date: endDate }
    };
  } else {
    datum.setHours(tijd.h, tijd.m, 0, 0);
    const startDate = new Date(datum);
    const endDate = new Date(startDate.getTime() + 30 * 60 * 1000);
    return {
      summary: title,
      start: { dateTime: startDate.toISOString(), timeZone: 'Europe/Amsterdam' },
      end: { dateTime: endDate.toISOString(), timeZone: 'Europe/Amsterdam' }
    };
  }
}

function levenshtein(a,b){
  const dp=[...Array(a.length+1)].map(()=>Array(b.length+1).fill(0));
  for(let i=0;i<=a.length;i++)dp[i][0]=i;
  for(let j=0;j<=b.length;j++)dp[0][j]=j;
  for(let i=1;i<=a.length;i++){
    for(let j=1;j<=b.length;j++){
      dp[i][j]=Math.min(
        dp[i-1][j]+1,
        dp[i][j-1]+1,
        dp[i-1][j-1]+(a[i-1]==b[j-1]?0:1)
      );
    }
  }
  return dp[a.length][b.length];
}

function formatTimeNL(isoString) {
  const d = new Date(isoString);
  return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
}

async function checkConflicts(event) {
  const start = event.start.dateTime || (event.start.date + "T00:00:00Z");
  const end = event.end.dateTime || (event.end.date + "T23:59:59Z");
  const res = await gapi.client.calendar.events.list({
    calendarId: 'primary',
    timeMin: start,
    timeMax: end,
    singleEvents: true,
    orderBy: 'startTime'
  });

  const newStart = new Date(start).getTime();
  const newEnd = new Date(end).getTime();

  const conflicts = [];

  for (const item of res.result.items) {
    const itemStart = new Date(item.start.dateTime || item.start.date + "T00:00:00Z").getTime();
    const itemEnd = new Date(item.end.dateTime || item.end.date + "T23:59:59Z").getTime();

    if (
      (newStart < itemEnd && newEnd > itemStart) ||
      Math.abs(newStart - itemEnd) < 30*60*1000 ||
      Math.abs(itemStart - newEnd) < 30*60*1000
    ) {
      conflicts.push(item);
    }
  }

  return conflicts;
}

async function addEvent() {
  if (!accessToken) {
    alert("Log eerst in met Google.");
    return;
  }

  const kleuren = ["1","2","3","4","5","6","7","8","9","10","11"];
  const kleurSelect = document.getElementById("kleur");
  const gekozen = kleurSelect.value === "random" ? kleuren[Math.floor(Math.random() * kleuren.length)] : kleurSelect.value;
  const text = document.getElementById("inputText").value.trim();

  if (!text) {
    alert("Voer eerst een tekst in.");
    return;
  }

  const event = parseTextToEvent(text);
  if (!event) return;

  event.colorId = gekozen;

  const conflicts = await checkConflicts(event);

  if (conflicts.length > 0) {
    let msg = `Er is al iets gepland rond dat tijdstip:\n\n`;
    for (const c of conflicts) {
      const tijd = c.start.dateTime || c.start.date + "T00:00:00Z";
      msg += `- ${c.summary} (${formatTimeNL(tijd)})\n`;
    }
    msg += `\nToch toevoegen?`;
    if (!confirm(msg)) return;
  }

  try {
    await gapi.client.calendar.events.insert({ calendarId: 'primary', resource: event });
    alert("Event toegevoegd!");
  } catch (error) {
    console.error(error);
    alert("Fout bij toevoegen van event.");
  }
}
</script>
</body>
</html>
