<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Agenda Tool met Parser</title>
  <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>
  <script>
    let tokenClient;
    let accessToken = null;

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: '',
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
      });
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: '424624995566-0aprf3c3739snsn0q752kj4slifditj3.apps.googleusercontent.com',
        scope: 'https://www.googleapis.com/auth/calendar.events',
        callback: (tokenResponse) => {
          accessToken = tokenResponse.access_token;
          document.getElementById("status").innerText = "Ingelogd âœ”";
        },
      });
    }

    function handleAuthClick() {
      tokenClient.requestAccessToken();
    }

    // Parser: zet tekst zoals "kapper maandag 14:00" of "kapper 17:00 tot 19:00" om naar een event object
    function parseTextToEvent(text) {
      const dagen = {
        'zondag': 0, 'maandag': 1, 'dinsdag': 2, 'woensdag': 3,
        'donderdag': 4, 'vrijdag': 5, 'zaterdag': 6
      };

      const dateRegex = /(?:(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?)/;
      const dayMatch = Object.keys(dagen).find(d => text.toLowerCase().includes(d));
      const dateMatch = text.match(dateRegex);

      let startTime, endTime;
      const timeRangeMatch = text.match(/(\d{1,2}):(\d{2})\s*(?:tot|\-)?\s*(\d{1,2}):(\d{2})/);
      if (timeRangeMatch) {
        startTime = { h: parseInt(timeRangeMatch[1]), m: parseInt(timeRangeMatch[2]) };
        endTime = { h: parseInt(timeRangeMatch[3]), m: parseInt(timeRangeMatch[4]) };
      } else {
        const timeMatch = text.match(/(\d{1,2}):(\d{2})/);
        if (!timeMatch) {
          alert("Geen tijd gevonden in de tekst.");
          return null;
        }
        startTime = { h: parseInt(timeMatch[1]), m: parseInt(timeMatch[2]) };
        endTime = null;
      }

      let eventDate = new Date();
      if (dayMatch) {
        const targetDay = dagen[dayMatch];
        const now = new Date();
        const dayDiff = (7 + targetDay - now.getDay()) % 7 || 7;
        eventDate.setDate(now.getDate() + dayDiff);
      } else if (dateMatch) {
        const [_, d, m, y] = dateMatch;
        const year = y ? parseInt(y) : new Date().getFullYear();
        eventDate = new Date(year, parseInt(m) - 1, parseInt(d));
      } else {
        // geen dag of datum gevonden
        alert("Geen geldige dag of datum gevonden.");
        return null;
      }

      eventDate.setHours(startTime.h, startTime.m, 0, 0);
      const startDate = new Date(eventDate);
      let endDate;
      if (endTime) {
        endDate = new Date(eventDate);
        endDate.setHours(endTime.h, endTime.m);
      } else {
        endDate = new Date(startDate.getTime() + 30 * 60 * 1000); // standaard 30 minuten
      }

      // Zoek alleen onderwerp
      const title = text.split(/\b(maandag|dinsdag|woensdag|donderdag|vrijdag|zaterdag|zondag|\d{1,2}[\/\-]\d{1,2}(?:[\/\-]\d{2,4})?)\b/)[0].trim();

      return {
        summary: title,
        start: {
          dateTime: startDate.toISOString(),
          timeZone: 'Europe/Amsterdam',
        },
        end: {
          dateTime: endDate.toISOString(),
          timeZone: 'Europe/Amsterdam',
        },
      };
    }

    async function addEvent() {
      if (!accessToken) {
        alert("Log eerst in met Google.");
        return;
      }
      const text = document.getElementById("inputText").value;
      const event = parseTextToEvent(text);
      if (!event) return;

      try {
        const request = gapi.client.calendar.events.insert({
          calendarId: 'primary',
          resource: event,
        });
        await request.execute();
        alert("Event toegevoegd!");
      } catch (error) {
        console.error(error);
        alert("Fout bij toevoegen van event.");
      }
    }
  </script>
</head>
<body onload="gapiLoaded();">
  <h1>Agenda Tool11</h1>
  <button onclick="handleAuthClick()">Log in met Google</button>
  <p id="status">Niet ingelogd</p>
  <textarea id="inputText" rows="4" cols="50" placeholder="Bijv: kapper maandag 14:00 of vergadering 5/7 15:00 tot 16:30"></textarea><br>
  <button onclick="addEvent()">Voeg toe aan agenda</button>

  <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>
</body>
</html>