<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Agenda Tool met Kleuren</title>
<style>
body {
  font-family: sans-serif;
  background-color: #f5f5f5;
  max-width: 700px;
  margin: auto;
  padding: 20px;
}
h1 { text-align: center; }
textarea, select, button, input {
  width: 100%;
  margin-top: 10px;
  font-size: 16px;
  padding: 10px;
  box-sizing: border-box;
}
#kleur { margin-bottom: 10px; }
label { font-weight: bold; display: block; margin-top: 10px; }
</style>
</head>
<body>
<h1>Agenda Tool</h1>

<button onclick="handleAuthClick()">Log in met Google</button>
<p id="status">Niet ingelogd</p>

<textarea id="inputText" rows="4" placeholder="Bijv: kapper 5 juli om half 4 of vergadering 6 juli 14:00"></textarea>

<label for="kleur">Kies kleur:</label>
<select id="kleur">
<option value="random" selected>🎲 Willekeurig</option>
<option value="11">❤️ Rood</option>
<option value="6">🟧 Oranje</option>
<option value="5">💛 Geel</option>
<option value="10">💚 Donkergroen</option>
<option value="2">💚 Lichtgroen</option>
<option value="9">💙 Blauw</option>
<option value="7">🫐 Bosbes</option>
<option value="3">💜 Lavendel</option>
<option value="4">🍇 Paars</option>
<option value="1">💗 Roze</option>
<option value="8">⚫ Grijs</option>
</select>

<label><input type="checkbox" id="heleDag"> Hele dag</label>

<label for="duur">Duur (in minuten, standaard 60):</label>
<input type="number" id="duur" min="1" placeholder="60">

<button onclick="addEvent()">➕ Voeg toe aan agenda</button>

<script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
let tokenClient;
let accessToken = null;

function gapiLoaded() {
  gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
  await gapi.client.init({
    apiKey: '',
    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
  });
}

window.onload = () => {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: 'VUL-HIER-JE-CLIENT-ID-IN',
    scope: 'https://www.googleapis.com/auth/calendar.events',
    callback: (tokenResponse) => {
      accessToken = tokenResponse.access_token;
      document.getElementById("status").innerText = "Ingelogd ✔";
    },
  });
};

function handleAuthClick() {
  tokenClient.requestAccessToken();
}

function levenshtein(a,b) {
  const dp = Array.from({length:a.length+1},()=>Array(b.length+1).fill(0));
  for (let i=0;i<=a.length;i++) dp[i][0]=i;
  for (let j=0;j<=b.length;j++) dp[0][j]=j;
  for (let i=1;i<=a.length;i++) {
    for (let j=1;j<=b.length;j++) {
      dp[i][j] = Math.min(
        dp[i-1][j]+1,
        dp[i][j-1]+1,
        dp[i-1][j-1]+(a[i-1]==b[j-1]?0:1)
      );
    }
  }
  return dp[a.length][b.length];
}

function parseTextToEvent(text) {
  const heleDag = document.getElementById("heleDag").checked;
  const duurMin = parseInt(document.getElementById("duur").value) || 60;

  text = text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
  const title = text.split(/\d{1,2}[:;]/)[0].split("om")[0].trim() || "Gebeurtenis";

  const monthMap = {
    januari:0,februari:1,maart:2,april:3,mei:4,juni:5,juli:6,
    augustus:7,september:8,oktober:9,november:10,december:11
  };

  const datum = (() => {
    const today = new Date();
    const m = text.match(/(\d{1,2})\s*([a-z]+)/i);
    if (m) {
      const dag = parseInt(m[1]);
      const maand = Object.keys(monthMap).find(mon => levenshtein(mon,m[2])<=2);
      if (maand) return new Date(today.getFullYear(),monthMap[maand],dag);
    }
    return today;
  })();

  const tijd = (() => {
    const hhmm = text.match(/(\d{1,2})[:;\s](\d{2})/);
    if (hhmm) return {h:parseInt(hhmm[1]),m:parseInt(hhmm[2])};

    const mod = text.match(/\b(half|kwart over|kwart voor)?\s*(\d{1,2})\b/);
    if (mod) {
      let u = parseInt(mod[2]), m=0;
      const t = mod[1];
      if (t==="half") {u=(u+23)%24;m=30;}
      if (t==="kwart over") {m=15;}
      if (t==="kwart voor") {u=(u+23)%24;m=45;}
      return {h:u,m};
    }
    return null;
  })();

  if (!heleDag && !tijd) {
    alert("Kon geen tijd vinden.");
    return null;
  }

  if (heleDag) {
    const startDate = datum.toISOString().split("T")[0];
    const endDate = new Date(datum.getTime() + 86400000).toISOString().split("T")[0];
    return {summary:title,start:{date:startDate},end:{date:endDate}};
  } else {
    datum.setHours(tijd.h,tijd.m,0,0);
    const start = new Date(datum);
    const end = new Date(start.getTime() + duurMin*60000);
    return {
      summary:title,
      start:{dateTime:start.toISOString(),timeZone:"Europe/Amsterdam"},
      end:{dateTime:end.toISOString(),timeZone:"Europe/Amsterdam"}
    };
  }
}

async function checkConflicts(event) {
  const start = event.start.dateTime || (event.start.date+"T00:00:00Z");
  const end = event.end.dateTime || (event.end.date+"T23:59:59Z");

  const res = await gapi.client.calendar.events.list({
    calendarId:'primary',timeMin:start,timeMax:end,
    singleEvents:true,orderBy:'startTime'
  });

  const ns = new Date(start).getTime(), ne = new Date(end).getTime();
  const conflicts = [];
  for (const item of res.result.items) {
    const is = new Date(item.start.dateTime || item.start.date+"T00:00:00Z").getTime();
    const ie = new Date(item.end.dateTime || item.end.date+"T23:59:59Z").getTime();
    if (ns<ie && ne>is) conflicts.push(item);
  }
  return conflicts;
}

async function addEvent() {
  if (!accessToken) { alert("Log eerst in."); return; }

  const text = document.getElementById("inputText").value.trim();
  if (!text) { alert("Voer tekst in."); return; }

  const event = parseTextToEvent(text);
  if (!event) return;

  const kleur = document.getElementById("kleur").value;
  event.colorId = kleur==="random" ? String(1+Math.floor(Math.random()*11)) : kleur;

  const conflicts = await checkConflicts(event);
  if (conflicts.length>0) {
    let msg = "Conflicten gevonden:\n";
    conflicts.forEach(c=>{
      msg+=`- ${c.summary}\n`;
    });
    msg+="Toch toevoegen?";
    if (!confirm(msg)) return;
  }

  await gapi.client.calendar.events.insert({calendarId:"primary",resource:event});
  alert("Toegevoegd!");
}
</script>
</body>
</html>
