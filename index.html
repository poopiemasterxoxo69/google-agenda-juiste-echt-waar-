<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Agenda Tool</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f5f5f5;
      max-width: 700px;
      margin: auto;
      padding: 20px;
    }
    h1 { text-align: center; }
    textarea, select, button {
      width: 100%;
      margin-top: 10px;
      font-size: 16px;
      padding: 10px;
    }
    #kleur, #heleDagContainer {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
<h1>Agenda Tool</h1>
<button onclick="handleAuthClick()">Log in met Google</button>
<p id="status">Niet ingelogd</p>
<textarea id="inputText" rows="6" placeholder="Bijv: kapper 5 juli 14:00&#10;vergadering 14:00 op 5/7"></textarea>

<label for="kleur">Kies kleur:</label>
<select id="kleur">
  <option value="random" selected>🎲 Willekeurig</option>
  <option value="11">❤️ Rood</option><option value="6">🟧 Oranje</option>
  <option value="5">💛 Geel</option><option value="10">💚 Donkergroen</option>
  <option value="2">💚 Lichtgroen</option><option value="9">💙 Blauw</option>
  <option value="7">🫐 Bosbes</option><option value="3">💜 Lavendel</option>
  <option value="4">🍇 Paars</option><option value="1">💗 Roze</option>
  <option value="8">⚫ Grijs</option>
</select>

<div id="heleDagContainer">
  <label><input type="checkbox" id="heleDag"> Hele dag</label>
</div>

<button onclick="addMultipleEvents()">➕ Voeg toe aan agenda</button>

<script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>
<script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>
<script>
let tokenClient;
let accessToken = null;

function gapiLoaded() {
  gapi.load('client', initializeGapiClient);
}
async function initializeGapiClient() {
  await gapi.client.init({
    apiKey: '',
    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
  });
}
function gisLoaded() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: '424624995566-0aprf3c3739snsn0q752kj4slifditj3.apps.googleusercontent.com',
    scope: 'https://www.googleapis.com/auth/calendar.events.readonly https://www.googleapis.com/auth/calendar.events',
    callback: (tokenResponse) => {
      accessToken = tokenResponse.access_token;
      document.getElementById("status").innerText = "Ingelogd ✔";
    },
  });
}
function handleAuthClick() {
  if (tokenClient) {
    tokenClient.requestAccessToken();
  } else {
    alert("Google auth is nog niet geladen.");
  }
}

function parseTextToEvent(text, heleDag) {
  const months = {
    januari:0,februari:1,maart:2,april:3,mei:4,juni:5,juli:6,
    augustus:7,september:8,oktober:9,november:10,december:11
  };

  const tijd = text.match(/(\d{1,2}):(\d{2})(?:\s*(?:tot|\-|–)\s*(\d{1,2}):(\d{2}))?/);
  let datum = new Date();
  const maandWords = text.match(/(\d{1,2})\s+(januari|februari|maart|april|mei|juni|juli|augustus|september|oktober|november|december)/i);
  const cijfers = text.match(/(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?/);

  if (maandWords) {
    const day = parseInt(maandWords[1]);
    const month = months[maandWords[2].toLowerCase()];
    datum = new Date(new Date().getFullYear(), month, day);
  } else if (cijfers) {
    const day = parseInt(cijfers[1]);
    const month = parseInt(cijfers[2]) - 1;
    const year = cijfers[3] ? parseInt(cijfers[3]) : new Date().getFullYear();
    datum = new Date(year, month, day);
  }

  const title = text.replace(/\d{1,2}[:\/]\d{2}.*/, '').replace(/\d{1,2}[\s\-\/](januari|februari|maart|april|mei|juni|juli|augustus|september|oktober|november|december)|\d{1,2}[\/\-]\d{1,2}(?:[\/\-]\d{2,4})?/, '').trim() || "Gebeurtenis";

  if (heleDag) {
    return {
      summary: title,
      start: { date: datum.toISOString().split('T')[0] },
      end: { date: new Date(datum.getTime() + 86400000).toISOString().split('T')[0] }
    };
  }

  if (!tijd) return null;
  const [_, h1, m1, h2, m2] = tijd.map(x => parseInt(x) || 0);
  const startDate = new Date(datum);
  startDate.setHours(h1, m1, 0, 0);
  const endDate = h2 ? new Date(datum.getFullYear(), datum.getMonth(), datum.getDate(), h2, m2) : new Date(startDate.getTime() + 30 * 60 * 1000);

  return {
    summary: title,
    start: { dateTime: startDate.toISOString(), timeZone: 'Europe/Amsterdam' },
    end: { dateTime: endDate.toISOString(), timeZone: 'Europe/Amsterdam' }
  };
}

async function checkConflictWithBuffer(event, bufferMinutes = 30) {
  const timeMin = new Date(new Date(event.start.dateTime).getTime() - bufferMinutes * 60000).toISOString();
  const timeMax = new Date(new Date(event.end.dateTime).getTime() + bufferMinutes * 60000).toISOString();

  const response = await gapi.client.calendar.events.list({
    calendarId: 'primary',
    timeMin,
    timeMax,
    singleEvents: true
  });

  return response.result.items.length > 0;
}

async function addEvent(event, kleurId) {
  event.colorId = kleurId;
  try {
    const hasConflict = await checkConflictWithBuffer(event, 30);
    if (hasConflict) {
      alert(`Niet toegevoegd: er zit minder dan 30 minuten tussen een bestaand event en: ${event.summary}`);
      return;
    }
    await gapi.client.calendar.events.insert({
      calendarId: 'primary',
      resource: event,
    }).execute();
  } catch (error) {
    console.error(error);
    alert("Fout bij toevoegen van event.");
  }
}

async function addMultipleEvents() {
  if (!accessToken) {
    alert("Log eerst in met Google.");
    return;
  }
  const kleuren = ["1","2","3","4","5","6","7","8","9","10","11"];
  const kleurSelect = document.getElementById("kleur");
  const gekozen = kleurSelect.value === "random" ? kleuren[Math.floor(Math.random() * kleuren.length)] : kleurSelect.value;
  const heleDag = document.getElementById("heleDag").checked;

  const lines = document.getElementById("inputText").value.split("\n");
  for (const line of lines) {
    if (line.trim() === "") continue;
    const event = parseTextToEvent(line.trim(), heleDag);
    if (event) await addEvent(event, gekozen);
  }
  alert("Klaar! Alle events verwerkt.");
}
</script>
</body>
</html>
