<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Agenda Tool</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      max-width: 700px;
      margin: auto;
      padding: 20px;
    }
    h1 { text-align: center; }
    textarea, select, button {
      width: 100%;
      font-size: 16px;
      padding: 10px;
      margin-top: 10px;
    }
    #tijdselectie { display: flex; gap: 10px; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>Agenda Tool</h1>
  <button onclick="handleAuthClick()">Log in met Google</button>
  <p id="status">Niet ingelogd</p>
  <textarea id="inputText" rows="8" placeholder="Voorbeeld:\nkapper donderdag 15:00\nrijles\nmaandag 14:00\nwoensdag 14:00\nvrijdag 15:15"></textarea>

  <label for="kleur">Kies kleur:</label>
  <select id="kleur">
    <option value="random" selected>🎲 Willekeurig</option>
    <option value="11">❤️ Rood</option><option value="6">🟧 Oranje</option>
    <option value="5">💛 Geel</option><option value="10">💚 Donkergroen</option>
    <option value="2">💚 Lichtgroen</option><option value="9">💙 Blauw</option>
    <option value="7">🫐 Bosbes</option><option value="3">💜 Lavendel</option>
    <option value="4">🍇 Paars</option><option value="1">💗 Roze</option>
    <option value="8">⚫ Grijs</option>
  </select>

  <button onclick="addMultipleEvents()">➕ Voeg toe aan agenda</button>

  <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    let accessToken = null;
    let tokenClient;

    function gapiLoaded() {
      gapi.load('client', async () => {
        await gapi.client.init({
          apiKey: '',
          discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
        });
      });
    }

    window.onload = () => {
      if (typeof google !== "undefined") {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: '424624995566-0aprf3c3739snsn0q752kj4slifditj3.apps.googleusercontent.com',
          scope: 'https://www.googleapis.com/auth/calendar.events',
          callback: (tokenResponse) => {
            accessToken = tokenResponse.access_token;
            document.getElementById("status").innerText = "Ingelogd ✔";
          },
        });
      }
    };

    function handleAuthClick() {
      if (tokenClient) {
        tokenClient.requestAccessToken();
      } else {
        alert("Google auth is nog niet geladen.");
      }
    }

    const dagen = ["zondag","maandag","dinsdag","woensdag","donderdag","vrijdag","zaterdag"];

    function volgendeDagDatum(vanaf, dagnaam) {
      const doel = dagen.indexOf(dagnaam.toLowerCase());
      if (doel === -1) return null;
      const diff = (doel + 7 - vanaf.getDay()) % 7 || 7;
      const result = new Date(vanaf);
      result.setDate(result.getDate() + diff);
      return result;
    }

    function parseInput(text) {
      const regels = text.trim().split(/\n+/);
      const events = [];
      let currentTitle = "";
      for (let regel of regels) {
        regel = regel.trim();
        if (regel === "") continue;

        // Titel + datum+tijd in één regel
        const combinedMatch = regel.match(/(.+?)\s+(maandag|dinsdag|woensdag|donderdag|vrijdag|zaterdag)\s+(\d{1,2}:\d{2})/i);
        if (combinedMatch) {
          currentTitle = combinedMatch[1].trim();
          const dag = combinedMatch[2].toLowerCase();
          const tijd = combinedMatch[3];
          events.push({ title: currentTitle, dag, tijd });
          continue;
        }

        // Alleen titel
        if (regel.match(/^[a-zA-Z\s]+$/) && !regel.match(/\d/)) {
          currentTitle = regel.trim();
          continue;
        }

        // Alleen dag + tijd
        const tijdmatch = regel.match(/(maandag|dinsdag|woensdag|donderdag|vrijdag|zaterdag)\s+(\d{1,2}:\d{2})/i);
        if (tijdmatch && currentTitle) {
          const dag = tijdmatch[1].toLowerCase();
          const tijd = tijdmatch[2];
          events.push({ title: currentTitle, dag, tijd });
        }
      }
      return events;
    }

    async function checkConflict(startISO, endISO) {
      const res = await gapi.client.calendar.events.list({
        calendarId: 'primary',
        timeMin: startISO,
        timeMax: endISO,
        singleEvents: true
      });
      return res.result.items.length ? res.result.items : null;
    }

    async function addMultipleEvents() {
      if (!accessToken) {
        alert("Log eerst in met Google.");
        return;
      }

      const kleur = document.getElementById("kleur").value;
      const kleuren = ["1","2","3","4","5","6","7","8","9","10","11"];
      const gekozenKleur = kleur === "random" ? kleuren[Math.floor(Math.random() * kleuren.length)] : kleur;

      const input = document.getElementById("inputText").value;
      const eventData = parseInput(input);
      const now = new Date();

      for (const ev of eventData) {
        const datum = volgendeDagDatum(now, ev.dag);
        const [h, m] = ev.tijd.split(":").map(Number);
        datum.setHours(h, m, 0, 0);
        const start = new Date(datum);
        const end = new Date(start.getTime() + 30 * 60 * 1000);

        const conflict = await checkConflict(start.toISOString(), end.toISOString());
        if (conflict) {
          const conflictnamen = conflict.map(e => e.summary).join(", ");
          const doorgaan = confirm(`⚠️ Er is al een event (${conflictnamen}) op ${start.toLocaleString()}. Toch toevoegen?`);
          if (!doorgaan) continue;
        }

        const nieuwEvent = {
          summary: ev.title,
          start: { dateTime: start.toISOString(), timeZone: 'Europe/Amsterdam' },
          end: { dateTime: end.toISOString(), timeZone: 'Europe/Amsterdam' },
          colorId: gekozenKleur
        };

        await gapi.client.calendar.events.insert({
          calendarId: 'primary',
          resource: nieuwEvent
        });
      }

      alert("✅ Toegevoegd aan agenda!");
    }
  </script>
</body>
</html>
