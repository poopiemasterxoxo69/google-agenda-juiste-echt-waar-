<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Agenda Tool</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f5f5f5;
      max-width: 700px;
      margin: auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    textarea, select, button {
      width: 100%;
      margin-top: 10px;
      font-size: 16px;
      padding: 10px;
    }
    #kleur, #duur {
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
    }
    #output {
      margin-top: 20px;
      background: #fff;
      padding: 15px;
      border: 1px solid #ccc;
    }
    .veld {
      margin-bottom: 8px;
    }

    #meerdereOutput {
  margin-top: 20px;
  background: #fff;
  padding: 15px;
  border: 1px solid #ccc;
}

  </style>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h1>Agenda Tool</h1>
  <div id="g_id_onload"
     data-client_id="YOUR_CLIENT_ID"
     data-callback="handleCredentialResponse"
     data-auto_prompt="false">
  </div>
  <button onclick="handleAuthClick()">Log in met Google</button>
  <p id="status">Niet ingelogd</p>

  <textarea id="inputText" rows="4" placeholder="Bijv: fysio maandag half drie of 'kapper 5 juli 14:00'"></textarea>

  <label for="kleur">Kies kleur:</label>
  <select id="kleur">
    <option value="random" selected>🎲 Willekeurig</option>
    <option value="11">❤️ Rood (Tomaat)</option>
    <option value="6">🟧 Oranje (Mandarijn)</option>
    <option value="5">💛 Geel (Zonnebloem)</option>
    <option value="10">💚 Donkergroen (Basilicum)</option>
    <option value="2">💚 Lichtgroen (Salie)</option>
    <option value="9">💙 Blauw (Pauw)</option>
    <option value="7">🫐 Bosbes</option>
    <option value="3">💜 Lavendel</option>
    <option value="4">🍇 Paars (Druif)</option>
    <option value="1">💗 Roze (Flamingo)</option>
    <option value="8">⚫ Grijs (Grafiet)</option>
  </select>

  <label for="duur">Kies duur:</label>
  <select id="duur">
    <option value="60" selected>⏱ 1 uur</option>
    <option value="30">🕧 30 minuten</option>
    <option value="45">🕐 45 minuten</option>
    <option value="90">🕜 1,5 uur</option>
    <option value="120">🕑 2 uur</option>
  </select>

  <label><input type="checkbox" id="heleDag"> Hele dag</label>
  <button id="herkenButton">🔍 Herken gegevens</button>
  <button id="voegToeButton">📅 Voeg toe aan agenda</button>

  <div id="output"></div>
  <div id="meerdereOutput"></div>

  <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    let tokenClient;
    let accessToken = null;

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: '',
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
      });
    }

    window.onload = () => {
      if (typeof google !== "undefined") {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: '424624995566-0aprf3c3739snsn0q752kj4slifditj3.apps.googleusercontent.com',
          scope: 'https://www.googleapis.com/auth/calendar.events.readonly https://www.googleapis.com/auth/calendar.events',
          callback: (tokenResponse) => {
            accessToken = tokenResponse.access_token;
            document.getElementById("status").innerText = "Ingelogd ✔";
          },
        });
      }

      // Voeg event listener toe aan de knop
      const voegToeBtn = document.getElementById('voegToeButton');
      if (voegToeBtn) {
        voegToeBtn.addEventListener('click', addEvent);
      }
    };

    function handleAuthClick() {
      if (tokenClient) {
        tokenClient.requestAccessToken();
      } else {
        alert("Google auth is nog niet geladen.");
      }
    }

    function parseTextToEvent(text) {
      // Simpele parser: zoekt tijd en datum in tekst
      const tijdRegex = /(\d{1,2}):(\d{2})/;
      const dateRegex = /(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?/;
      let startH = 0, startM = 0;
      let datum = new Date();
      let tijdMatch = text.match(tijdRegex);
      if (tijdMatch) {
        startH = parseInt(tijdMatch[1]);
        startM = parseInt(tijdMatch[2]);
      }
      let dateMatch = text.match(dateRegex);
      if (dateMatch) {
        let jaar = dateMatch[3] ? parseInt(dateMatch[3]) : datum.getFullYear();
        let maand = parseInt(dateMatch[2]) - 1;
        let dag = parseInt(dateMatch[1]);
        datum = new Date(jaar, maand, dag, startH, startM);
      } else {
        datum.setHours(startH, startM, 0, 0);
      }
      return { titel: text, datum };
    }

    async function addEvent() {
      if (!accessToken) {
        alert("Log eerst in met Google.");
        return;
      }
      const text = document.getElementById('inputText').value;
      const kleur = document.getElementById('kleur').value;
      const duur = parseInt(document.getElementById('duur').value);
      const heleDag = document.getElementById('heleDag').checked;
      // Detecteer of er meerdere afspraken zijn
      let meerdereAfspraken = false;
      let tijdMatches = text.match(/(\d{1,2}[:.]\d{2})/g);
      let dagRegex = /(zondag|maandag|dinsdag|woensdag|donderdag|vrijdag|zaterdag)/i;
      let dagMatches = text.match(new RegExp(dagRegex, 'gi'));
      let datumMatches = text.match(/\b\d{1,2}[\/\-]\d{1,2}(?:[\/\-]\d{2,4})?\b/g);
      if ((tijdMatches && tijdMatches.length > 1) || (dagMatches && dagMatches.length > 1) || (datumMatches && datumMatches.length > 1)) {
        meerdereAfspraken = true;
      }
      let afspraken = [];
      if (meerdereAfspraken) {
        if (typeof window.parseMeerdereAfsprakenInRegel !== 'function') {
          alert('De functie parseMeerdereAfsprakenInRegel is niet beschikbaar. Zorg dat script_tool.js correct wordt geladen.');
          return;
        }
        afspraken = window.parseMeerdereAfsprakenInRegel(text);
        // Hoofd-titel bepalen voor fallback
        let dagNamen = ["zondag","maandag","dinsdag","woensdag","donderdag","vrijdag","zaterdag"];
        let dagRegex2 = dagNamen.join("|");
        let eersteBlok = text.split(new RegExp(`[\r\n\.]+|, (?=${dagRegex2})`, 'i')).find(r => new RegExp(`\\b(${dagRegex2})\\b`, 'i').test(r));
        let hoofdTitel = null;
        if (eersteBlok) {
          let dagMatch = eersteBlok.match(new RegExp(`^(.*?)\\b(${dagRegex2})\\b`, 'i'));
          if (dagMatch && dagMatch[1].trim().length > 0) {
            hoofdTitel = window.titelopschoner ? window.titelopschoner(dagMatch[1].trim()) : dagMatch[1].trim();
          }
        }
        // Fallback hoofd-titel toepassen
        afspraken = afspraken.map(afspraak => {
          let schoneTitel = window.titelopschoner ? window.titelopschoner(afspraak.titel) : afspraak.titel;
          if (!schoneTitel || schoneTitel === "Onbekende afspraak") {
            schoneTitel = hoofdTitel ? hoofdTitel : "Onbekende afspraak";
          }
          return { ...afspraak, titel: schoneTitel };
        });
      } else {
        // Simpele parser voor 1 afspraak
        let afspraak = window.parseTextToEvent ? window.parseTextToEvent(text) : { titel: text, datum: new Date() };
        afspraak.titel = window.titelopschoner ? window.titelopschoner(afspraak.titel) : afspraak.titel;
        afspraken = [afspraak];
      }
      if (!afspraken.length) {
        alert('Geen afspraken gevonden in de tekst.');
        return;
      }
      let toegevoegd = 0;
      let details = '';
      for (const afspraak of afspraken) {
        let datum = afspraak.datum instanceof Date ? afspraak.datum : new Date(afspraak.datum);
        let start, end;
        if (heleDag) {
          start = { date: datum.toISOString().slice(0,10) };
          end = { date: datum.toISOString().slice(0,10) };
        } else {
          let tijdSplit = (afspraak.tijd||'').split(':');
          if (tijdSplit.length === 2) {
            datum.setHours(parseInt(tijdSplit[0]), parseInt(tijdSplit[1]), 0, 0);
          }
          start = { dateTime: datum.toISOString(), timeZone: 'Europe/Amsterdam' };
          let endDate = new Date(datum.getTime() + duur*60000);
          end = { dateTime: endDate.toISOString(), timeZone: 'Europe/Amsterdam' };
        }
        const event = {
          summary: afspraak.titel || 'Afspraak',
          start,
          end,
          colorId: kleur === 'random' ? undefined : kleur
        };
        try {
          await gapi.client.calendar.events.insert({ calendarId: 'primary', resource: event });
          toegevoegd++;
          details += `\nTitel: ${event.summary}\nDatum: ${heleDag ? start.date : datum.toLocaleString()}\nTijd: ${afspraak.tijd || ''}\nKleur: ${kleur}\nDuur: ${duur} min\n---`;
        } catch (e) {
          details += `\nFout bij toevoegen van afspraak: ${event.summary} (${e.message})`;
        }
      }
      alert(`${toegevoegd} afspraak/afspraken toegevoegd aan je Google Agenda!${details}`);
    }
  </script>
  <script src="script_tool.js"></script>
</body>
</html>