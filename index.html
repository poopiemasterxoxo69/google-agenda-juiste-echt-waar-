<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Agenda Tool</title>
<style>
body {
  font-family: sans-serif;
  background-color: #f5f5f5;
  max-width: 700px;
  margin: auto;
  padding: 20px;
}
h1 { text-align: center; }
textarea, select, button {
  width: 100%;
  margin-top: 10px;
  font-size: 16px;
  padding: 10px;
}
#kleur, #duur { margin-bottom: 20px; }
label { font-weight: bold; }
</style>
</head>
<body>
<h1>Agenda Tool</h1>
<button onclick="handleAuthClick()">Log in met Google</button>
<p id="status">Niet ingelogd</p>
<textarea id="inputText" rows="4" placeholder="Bijv: kapper vrijdag 5 juli om half 4"></textarea>

<label for="kleur">Kies kleur:</label>
<select id="kleur">
<option value="random" selected>🎲 Willekeurig</option>
<option value="11">❤️ Rood</option>
<option value="6">🟧 Oranje</option>
<option value="5">💛 Geel</option>
<option value="10">💚 Donkergroen</option>
<option value="2">💚 Lichtgroen</option>
<option value="9">💙 Blauw</option>
<option value="7">🫐 Bosbes</option>
<option value="3">💜 Lavendel</option>
<option value="4">🍇 Paars</option>
<option value="1">💗 Roze</option>
<option value="8">⚫ Grijs</option>
</select>

<label for="duur">Duur:</label>
<select id="duur">
<option value="30">30 min</option>
<option value="60" selected>1 uur</option>
<option value="90">1,5 uur</option>
<option value="120">2 uur</option>
</select>

<label><input type="checkbox" id="heleDag"> Hele dag</label>

<button onclick="addEvent()">➕ Voeg toe aan agenda</button>

<script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
let tokenClient;
let accessToken = null;

function gapiLoaded() {
  gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
  await gapi.client.init({
    apiKey: '',
    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
  });
}

window.onload = () => {
  if (typeof google !== "undefined") {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: '424624995566-0aprf3c3739snsn0q752kj4slifditj3.apps.googleusercontent.com',
      scope: 'https://www.googleapis.com/auth/calendar.events.readonly https://www.googleapis.com/auth/calendar.events',
      callback: (tokenResponse) => {
        accessToken = tokenResponse.access_token;
        document.getElementById("status").innerText = "Ingelogd ✔";
      },
    });
  }
};

function handleAuthClick() {
  if (tokenClient) {
    tokenClient.requestAccessToken();
  } else {
    alert("Google auth is nog niet geladen.");
  }
}

function parseTextToEvent(text) {
  const heleDag = document.getElementById("heleDag").checked;
  const duurMinuten = parseInt(document.getElementById("duur").value);
  text = text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

  const title = text.split(/\d{1,2}[:;]/)[0].split("om")[0].trim() || "Gebeurtenis";

  const monthMap = {
    januari:0,februari:1,maart:2,april:3,mei:4,juni:5,juli:6,
    augustus:7,september:8,oktober:9,november:10,december:11
  };

  const dayMap = {
    maandag:1,dinsdag:2,woensdag:3,donderdag:4,vrijdag:5,zaterdag:6,zondag:0
  };

  const today = new Date();
  let datum = new Date(today);

  const dateMatch = text.match(/(\d{1,2})\s*(j[a-z]+)/i);
  const dayMatch = Object.keys(dayMap).find(d => text.includes(d));

  if (dateMatch) {
    const day = parseInt(dateMatch[1]);
    const monthName = Object.keys(monthMap).find(m => levenshtein(m, dateMatch[2]) <= 2);
    if (monthName) {
      datum = new Date(today.getFullYear(), monthMap[monthName], day);
    }
  }

  if (dayMatch) {
    const targetDow = dayMap[dayMatch];
    while (datum.getDay() !== targetDow) {
      datum.setDate(datum.getDate() + 1);
    }
  }

  const tijd = (() => {
    const hhmm = text.match(/(\d{1,2})[:;\s](\d{2})/);
    let hint = '';
    if (text.includes("ochtend")) hint = "ochtend";
    if (text.includes("middag")) hint = "middag";
    if (text.includes("avond")) hint = "avond";

    if (hhmm) {
      let h = parseInt(hhmm[1]), m = parseInt(hhmm[2]);
      if (!hint && h < 8) h += 12;
      if (hint === "ochtend" && h >= 12) h -= 12;
      if (hint === "avond" && h < 12) h += 12;
      return {h, m};
    }

    const tekstTijd = text.match(/\b(half|kwart over|kwart voor)?\s*(\d{1,2})\b/);
    if (tekstTijd) {
      let uur = parseInt(tekstTijd[2]);
      let min = 0;
      const mod = tekstTijd[1] ? tekstTijd[1].toLowerCase() : '';
      if (mod === 'half') {
        uur = (uur - 1 + 24) % 24;
        min = 30;
      } else if (mod === 'kwart over') {
        min = 15;
      } else if (mod === 'kwart voor') {
        uur = (uur - 1 + 24) % 24;
        min = 45;
      }

      if (!hint && uur < 8) uur += 12;
      if (hint === "ochtend" && uur >= 12) uur -= 12;
      if (hint === "avond" && uur < 12) uur += 12;
      return {h: uur, m: min};
    }

    return null;
  })();

  if (!heleDag && !tijd) {
    alert("Kon geen geldige tijd vinden.");
    return null;
  }

  if (heleDag) {
    const startDate = datum.toISOString().split("T")[0];
    const endDate = new Date(datum.getTime() + 24 * 60 * 60 * 1000).toISOString().split("T")[0];
    return {
      summary: title,
      start: { date: startDate },
      end: { date: endDate }
    };
  } else {
    datum.setHours(tijd.h, tijd.m, 0, 0);
    const startDate = new Date(datum);
    const endDate = new Date(startDate.getTime() + duurMinuten * 60 * 1000);
    return {
      summary: title,
      start: { dateTime: startDate.toISOString(), timeZone: 'Europe/Amsterdam' },
      end: { dateTime: endDate.toISOString(), timeZone: 'Europe/Amsterdam' }
    };
  }
}

function levenshtein(a,b){
  const dp=[...Array(a.length+1)].map(()=>Array(b.length+1).fill(0));
  for(let i=0;i<=a.length;i++)dp[i][0]=i;
  for(let j=0;j<=b.length;j++)dp[0][j]=j;
  for(let i=1;i<=a.length;i++){
    for(let j=1;j<=b.length;j++){
      dp[i][j]=Math.min(
        dp[i-1][j]+1,
        dp[i][j-1]+1,
        dp[i-1][j-1]+(a[i-1]==b[j-1]?0:1)
      );
    }
  }
  return dp[a.length][b.length];
}

async function addEvent() {
  if (!accessToken) {
    alert("Log eerst in met Google.");
    return;
  }

  const kleuren = ["1","2","3","4","5","6","7","8","9","10","11"];
  const kleurSelect = document.getElementById("kleur");
  const gekozen = kleurSelect.value === "random" ? kleuren[Math.floor(Math.random() * kleuren.length)] : kleurSelect.value;
  const text = document.getElementById("inputText").value.trim();

  if (!text) {
    alert("Voer eerst een tekst in.");
    return;
  }

  const event = parseTextToEvent(text);
  if (!event) return;

  event.colorId = gekozen;

  try {
    await gapi.client.calendar.events.insert({ calendarId: 'primary', resource: event });
    alert("Event toegevoegd!");
  } catch (error) {
    console.error(error);
    alert("Fout bij toevoegen van event.");
  }
}
</script>
</body>
</html>
