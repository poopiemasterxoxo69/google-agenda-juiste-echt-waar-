<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Agenda Tool</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f5f5f5;
      max-width: 700px;
      margin: auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    textarea, select, button {
      width: 100%;
      margin-top: 10px;
      font-size: 16px;
      padding: 10px;
    }
    #kleur, #duur {
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
    }
    #output {
      margin-top: 20px;
      background: #fff;
      padding: 15px;
      border: 1px solid #ccc;
    }
    .veld {
      margin-bottom: 8px;
    }

    #meerdereOutput {
  margin-top: 20px;
  background: #fff;
  padding: 15px;
  border: 1px solid #ccc;
}

  </style>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f5f5f5;
      max-width: 700px;
      margin: auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    textarea, select, button {
      width: 100%;
      margin-top: 10px;
      font-size: 16px;
      padding: 10px;
    }
    #kleur {
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Agenda Tool</h1>
  <button onclick="handleAuthClick()">Log in met Google</button>
<p id="status">Niet ingelogd</p>
<textarea id="inputText" rows="4" placeholder="Bijv: kapper 5 juli 14:00 of vergadering 14:00 op 5/7"></textarea>

<button id="herkenButton" style="background:#34a853; margin-top:10px;">ğŸ” Herken gegevens</button>

<label for="kleur">Kies kleur:</label>
<select id="kleur">
    <option value="random" selected>ğŸ² Willekeurig</option>
    <option value="11">â¤ï¸ Rood (Tomaat)</option>
    <option value="6">ğŸŸ§ Oranje (Mandarijn)</option>
    <option value="5">ğŸ’› Geel (Zonnebloem)</option>
    <option value="10">ğŸ’š Donkergroen (Basilicum)</option>
    <option value="2">ğŸ’š Lichtgroen (Salie)</option>
    <option value="9">ğŸ’™ Blauw (Pauw)</option>
    <option value="7">ğŸ« Bosbes</option>
    <option value="3">ğŸ’œ Lavendel</option>
    <option value="4">ğŸ‡ Paars (Druif)</option>
    <option value="1">ğŸ’— Roze (Flamingo)</option>
    <option value="8">âš« Grijs (Grafiet)</option>
  </select>

  <label><input type="checkbox" id="heleDag"> Hele dag</label>

  <button id="addEventButton">â• Voeg toe aan agenda</button>

<div id="output"></div>
<div id="meerdereOutput"></div>

<script>
    // --- Google API Loader ---
    (function ensureGapiLoadedAndCallGapiLoaded() {
      if (window.gapi) {
        if (typeof window.gapiLoaded === 'function') {
          window.gapiLoaded();
        }
        return;
      }
      var existingScript = document.querySelector('script[src="https://apis.google.com/js/api.js"]');
      if (existingScript) {
        if (!existingScript.hasAttribute('data-gapi-onload')) {
          existingScript.setAttribute('data-gapi-onload', '1');
          existingScript.addEventListener('load', function() {
            if (typeof window.gapiLoaded === 'function') {
              window.gapiLoaded();
            }
          });
        }
        return;
      }
      var script = document.createElement('script');
      script.src = 'https://apis.google.com/js/api.js';
      script.async = true;
      script.defer = true;
      script.onload = function() {
        if (typeof window.gapiLoaded === 'function') {
          window.gapiLoaded();
        }
      };
      document.head.appendChild(script);
    })();

    let tokenClient;
    let accessToken = null;

    // === Hulpfuncties uit script_tool.js ===
    function todayWithoutTime() {
      const d = new Date();
      d.setHours(0, 0, 0, 0);
      return d;
    }
    function opschonenTitel(tekst) {
      let t = tekst.toLowerCase();
      const woordenWeg = [
        "januari","februari","maart","april","mei","juni","juli","augustus","september","oktober","november","december",
        "kwart","over","voor","half","uur","u","om","tijd","datum",
        "â€™s ochtends","â€™s middags","â€™s avonds","s ochtends","s middags","s avonds"
      ];
      for (let woord of woordenWeg) {
        const re = new RegExp("\\b" + woord + "\\b", "gi");
        t = t.replace(re, "");
      }
      t = t.replace(/\b\d+\b/g, "");
      t = t.replace(/\d{1,2}[:.]\d{2}/g, "");
      t = t.replace(/[:\-]/g, "");
      t = t.replace(/\s+/g, " ").trim();
      if (t.length > 0) {
        t = t.charAt(0).toUpperCase() + t.slice(1);
      } else {
        t = "Onbekende afspraak";
      }
      return t;
    }
    function parseTextToEvent(text, weekContext = null) {
      const origineleTekst = text.toLowerCase();
      let datum = null;
      let weeknr = null;
      const dagen = {
        zondag: 0, maandag: 1, dinsdag: 2, woensdag: 3, donderdag: 4,
        vrijdag: 5, zaterdag: 6
      };
      const vandaag = new Date();
      // Weeknummer parsing
      const weekMatch = text.match(/week\s*(\d{1,2})/i);
      if (weekMatch) {
        weeknr = parseInt(weekMatch[1]);
      }
      let gevondenDag = null;
      for (let dagNaam in dagen) {
        if (origineleTekst.includes(dagNaam)) {
          const vandaagDag = vandaag.getDay();
          const doelDag = dagen[dagNaam];
          let verschil = doelDag - vandaagDag;
          if (verschil <= 0) verschil += 7;
          gevondenDag = dagNaam;
          datum = new Date(todayWithoutTime());
          datum.setDate(datum.getDate() + verschil);
          break;
        }
      }
      // Flexibele datum/tijd parsing
      const datumRegex = /(?:datum[:\s]*)?(\d{1,2})[\/-](\d{1,2})(?:[\/-](\d{2,4}))?|(?:datum[:\s]*)?(\d{1,2})\s+(januari|februari|maart|april|mei|juni|juli|augustus|september|oktober|november|december)(?:\s+(\d{4}))?/i;
      const tijdLabelRegex = /tijd[:\s]*([0-9]{1,2}[:.][0-9]{2})/i;
      const dateMatch = datumRegex.exec(origineleTekst);
      let tijdLabelMatch = tijdLabelRegex.exec(origineleTekst);
      let tijdLabel = tijdLabelMatch ? tijdLabelMatch[1].replace('.', ':') : null;
      if (dateMatch) {
        if (dateMatch[1] && dateMatch[2]) {
          const day = parseInt(dateMatch[1]);
          const month = parseInt(dateMatch[2]) - 1;
          const year = dateMatch[3] ? parseInt(dateMatch[3]) : new Date().getFullYear();
          datum = new Date(year, month, day);
        } else if (dateMatch[4] && dateMatch[5]) {
          const maanden = {
            januari: 0, februari: 1, maart: 2, april: 3, mei: 4, juni: 5,
            juli: 6, augustus: 7, september: 8, oktober: 9, november: 10, december: 11
          };
          const day = parseInt(dateMatch[4]);
          const month = maanden[dateMatch[5].toLowerCase()];
          const year = dateMatch[6] ? parseInt(dateMatch[6]) : new Date().getFullYear();
          datum = new Date(year, month, day);
        }
      }
      const woordNaarGetal = {
        een: 1, twee: 2, drie: 3, vier: 4, vijf: 5, zes: 6, zeven: 7, acht: 8, negen: 9, tien: 10,
        elf: 11, twaalf: 12, dertien: 13, veertien: 14, vijftien: 15, zestien: 16,
        zeventien: 17, achttien: 18, negentien: 19, twintig: 20
      };
      function woordOfGetal(w) {
        if (!w) return null;
        return isNaN(w) ? woordNaarGetal[w.toLowerCase()] ?? null : parseInt(w);
      }
      function adjustTime(h) {
        if (h != null && h < 8) return h + 12;
        return h;
      }
      let startH = null, startM = null;
      const tijdRegexes = [
        { re: /(\w+)\s*over\s*half\s*(\w+)/gi, calc: (m, h) => [adjustTime(woordOfGetal(h) - 1), 30 + woordOfGetal(m)] },
        { re: /(\w+)\s*voor\s*half\s*(\w+)/gi, calc: (m, h) => [adjustTime(woordOfGetal(h) - 1), 30 - woordOfGetal(m)] },
        { re: /kwart over (\w+)/gi, calc: h => [adjustTime(woordOfGetal(h)), 15] },
        { re: /kwart voor (\w+)/gi, calc: h => [adjustTime(woordOfGetal(h) - 1), 45] },
        { re: /half (\w+)/gi, calc: h => [adjustTime(woordOfGetal(h) - 1), 30] },
        { re: /(\d{1,2}):(\d{2})/gi, calc: (h, m) => [parseInt(h), parseInt(m)] },
        { re: /(\d{1,2})\s*(uur|u)/gi, calc: h => [adjustTime(parseInt(h)), 0] },
        { re: /(\w+)\s*(uur|u)/gi, calc: h => [adjustTime(woordOfGetal(h)), 0] }
      ];
      for (let tijdRe of tijdRegexes) {
        let match;
        while ((match = tijdRe.re.exec(origineleTekst)) !== null) {
          let res;
          try {
            res = tijdRe.calc(...match.slice(1));
          } catch {
            res = null;
          }
          if (res && res[0] != null && res[1] != null) {
            startH = res[0];
            startM = res[1];
            break;
          }
        }
        if (startH !== null) break;
      }
      // Weekcontext: als geen datum gevonden, maar weeknr en dag, bereken datum
      if (!datum && weeknr && gevondenDag) {
        // Bepaal eerste dag van het jaar
        const year = new Date().getFullYear();
        const simple = new Date(year, 0, 1 + (weeknr - 1) * 7);
        const dagVanSimple = simple.getDay();
        const doelDag = dagen[gevondenDag];
        // Corrigeer naar juiste dag in de week
        let diff = doelDag - dagVanSimple;
        if (diff < 0) diff += 7;
        simple.setDate(simple.getDate() + diff);
        datum = simple;
      }
      const titel = opschonenTitel(text);
      // Tijd uit 'tijd:' label, als geen andere tijd gevonden
      let tijdResultaat = startH !== null && startM !== null
        ? `${startH.toString().padStart(2, "0")}:${startM.toString().padStart(2, "0")}`
        : tijdLabel;
      return {
        titel: titel,
        datum: datum,
        tijd: tijdResultaat
      };
    }
    function parseMeerdereAfsprakenInRegel(tekst) {
      let weekMatch = tekst.match(/week\s*(\d{1,2})/i);
      let weeknr = weekMatch ? parseInt(weekMatch[1]) : null;
      let weekContext = weeknr ? weeknr : null;
      let hoofdTitel = null;
      let eersteRegel = tekst.split(/[\r\n\.]+/).find(r => /\b(zondag|maandag|dinsdag|woensdag|donderdag|vrijdag|zaterdag)\b/i.test(r));
      if (eersteRegel) {
        let dagMatch = eersteRegel.match(/^(.*?)\b(zondag|maandag|dinsdag|woensdag|donderdag|vrijdag|zaterdag)\b/i);
        if (dagMatch && dagMatch[1].trim().length > 0) {
          hoofdTitel = opschonenTitel(dagMatch[1].trim());
        }
      }
      const regels = tekst.split(/[\r\n\.]+/).map(r => r.trim()).filter(r => r.length > 0);
      let afspraken = [];
      let laatsteDag = null;
      for (let regel of regels) {
        let dagMatch = regel.match(/\b(zondag|maandag|dinsdag|woensdag|donderdag|vrijdag|zaterdag)\b/i);
        if (dagMatch) {
          laatsteDag = dagMatch[1].toLowerCase();
        }
        let dagNaam = laatsteDag;
        let titleBeforeDay = dagMatch ? regel.substring(0, dagMatch.index).trim() : "";
        let baseTitle = titleBeforeDay ? opschonenTitel(titleBeforeDay) : hoofdTitel || "";
        let naDag = dagMatch ? regel.substring(dagMatch.index + dagNaam.length).trim() : regel;
        const tijdRegex = /(\d{1,2}[:.]\d{2})/g;
        let tijdLabelRegex = /tijd[:\s]*([0-9]{1,2}[:.][0-9]{2})/gi;
        let tijdLabelMatches = [];
        let match;
        while ((match = tijdLabelRegex.exec(naDag)) !== null) {
          tijdLabelMatches.push(match[1].replace('.', ':'));
        }
        let parts = naDag.split(tijdRegex).filter(Boolean);
        if (tijdLabelMatches.length > 0) {
          parts = tijdLabelMatches;
        }
        for (let i = 0; i < parts.length; i++) {
          let s = parts[i].trim();
          if (/^\d{1,2}[:.]\d{2}$/.test(s) || /^\d{1,2}[:.]\d{2}$/.test(parts[i])) {
            let tijd = s.replace(".", ":");
            let extraTitel = "";
            if (i + 1 < parts.length && !/^\d{1,2}[:.]\d{2}$/.test(parts[i + 1])) {
              extraTitel = opschonenTitel(parts[i + 1].trim());
            }
            let afspraakTitel = baseTitle;
            if (extraTitel && extraTitel !== "Onbekende afspraak") {
              afspraakTitel = afspraakTitel
                ? afspraakTitel + " â€“ " + extraTitel
                : extraTitel;
            }
            if (
              extraTitel &&
              extraTitel.toLowerCase() === "examen" &&
              !/examen/i.test(afspraakTitel)
            ) {
              afspraakTitel += afspraakTitel ? " â€“ Examen" : "Examen";
            }
            if (!afspraakTitel || afspraakTitel.toLowerCase() === dagNaam || afspraakTitel === "Onbekende afspraak") {
              afspraakTitel = hoofdTitel || "Onbekende afspraak";
            }
            let parseString = dagNaam + " " + tijd;
            if (extraTitel && !baseTitle) {
              parseString += " " + extraTitel;
            }
            let event = parseTextToEvent(parseString, weekContext);
            event.titel = afspraakTitel ? afspraakTitel : event.titel;
            afspraken.push({
              titel: event.titel,
              datum: event.datum,
              tijd: event.tijd
            });
          }
        }
      }
      return afspraken;
    }
    function parseEnToon() {
      const tekst = document.getElementById("inputText").value;
      const tijdMatches = tekst.match(/(\d{1,2}[:.]\d{2})/g);
      const kleur = document.getElementById("kleur").value;
      const duur = document.getElementById("duur") ? document.getElementById("duur").value : 30;
      const heleDag = document.getElementById("heleDag").checked;
      let afspraken = [];
      if (tijdMatches && tijdMatches.length > 1) {
        afspraken = parseMeerdereAfsprakenInRegel(tekst);
      } else {
        afspraken = [parseTextToEvent(tekst)];
      }
      if (afspraken.length > 0) {
        let html = "";
        afspraken.forEach((afspraak, index) => {
          const datumStr = afspraak.datum && afspraak.datum.toLocaleDateString
            ? afspraak.datum.toLocaleDateString("nl-NL")
            : "Onbekend";
          html += `
            <div class="veld"><strong>ğŸ“Œ Titel:</strong> ${afspraak.titel}</div>
            <div class="veld"><strong>ğŸ“… Datum:</strong> ${datumStr}</div>
            <div class="veld"><strong>â° Starttijd:</strong> ${heleDag ? "hele dag" : (afspraak.tijd || "Onbekend")}</div>
            <div class="veld"><strong>ğŸ•’ Duur:</strong> ${heleDag ? "n.v.t." : `${duur} minuten`}</div>
            <div class="veld"><strong>ğŸ¨ Kleur:</strong> ${kleur === "random" ? "Willekeurig" : kleur}</div>
          `;
          if (index < afspraken.length - 1) html += "<hr>";
        });
        if(document.getElementById("output")) document.getElementById("output").innerHTML = html;
        if (document.getElementById("meerdereOutput")) {
          document.getElementById("meerdereOutput").innerHTML = "";
        }
      } else {
        if(document.getElementById("output")) document.getElementById("output").innerText = "Geen afspraken gevonden.";
        if (document.getElementById("meerdereOutput")) {
          document.getElementById("meerdereOutput").innerText = "";
        }
      }
    }
    document.addEventListener("DOMContentLoaded", () => {
      const knop = document.getElementById("herkenButton");
      if (knop) {
        knop.addEventListener("click", parseEnToon);
      }
      const addButton = document.getElementById("addEventButton");
      if (addButton) {
        addButton.addEventListener("click", addEvent);
      }
    });

    // === EINDE hulpfuncties ===

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: '',
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
      });
    }

    window.onload = () => {
      if (typeof google !== "undefined") {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: '424624995566-0aprf3c3739snsn0q752kj4slifditj3.apps.googleusercontent.com',
          scope: 'https://www.googleapis.com/auth/calendar.events.readonly https://www.googleapis.com/auth/calendar.events',
          callback: (tokenResponse) => {
            accessToken = tokenResponse.access_token;
            document.getElementById("status").innerText = "Ingelogd âœ”";
          },
        });
      }
    };

    function handleAuthClick() {
      if (tokenClient) {
        tokenClient.requestAccessToken();
      } else {
        alert("Google auth is nog niet geladen.");
      }
    }

    function parseTextToEvent(text) {
      const tijd = text.match(/(\d{1,2}):(\d{2})(?:\s*(?:tot|\-|â€“)\s*(\d{1,2}):(\d{2}))?/);
      let startH = 0, startM = 0, endH = null, endM = null;
      if (tijd) {
        startH = parseInt(tijd[1]);
        startM = parseInt(tijd[2]);
        if (tijd[3]) endH = parseInt(tijd[3]);
        if (tijd[4]) endM = parseInt(tijd[4]);
      }
      let datum = new Date();
      const dateMatch = text.match(/(\d{1,2})[\/-](\d{1,2})(?:[\/-](\d{2,4}))?|\b(\d{1,2})\s+(januari|februari|maart|april|mei|juni|juli|augustus|september|oktober|november|december)\b/i);
      if (dateMatch) {
        if (dateMatch[1] && dateMatch[2]) {
          const day = parseInt(dateMatch[1]);
          const month = parseInt(dateMatch[2]) - 1;
          const year = dateMatch[3] ? parseInt(dateMatch[3]) : new Date().getFullYear();
          datum = new Date(year, month, day);
        } else if (dateMatch[4] && dateMatch[5]) {
          const months = {januari:0,februari:1,maart:2,april:3,mei:4,juni:5,juli:6,augustus:7,september:8,oktober:9,november:10,december:11};
          const day = parseInt(dateMatch[4]);
          const month = months[dateMatch[5].toLowerCase()];
          datum = new Date(new Date().getFullYear(), month, day);
        }
      }
      const title = text.split(/\d{1,2}[:\/]/)[0].trim() || "Gebeurtenis";
      const heleDag = document.getElementById("heleDag").checked;
      if (heleDag) {
        const startDate = datum.toISOString().split("T")[0];
        const endDate = new Date(datum.getTime() + 24 * 60 * 60 * 1000).toISOString().split("T")[0];
        return {
          summary: title,
          start: { date: startDate },
          end: { date: endDate }
        };
      } else {
        datum.setHours(startH, startM, 0, 0);
        const startDate = new Date(datum);
        const endDate = endH !== null ? new Date(datum.getFullYear(), datum.getMonth(), datum.getDate(), endH, endM || 0) : new Date(startDate.getTime() + 30 * 60 * 1000);
        return {
          summary: title,
          start: { dateTime: startDate.toISOString(), timeZone: 'Europe/Amsterdam' },
          end: { dateTime: endDate.toISOString(), timeZone: 'Europe/Amsterdam' }
        };
      }
    }

    async function checkConflict(event) {
      const start = event.start.dateTime || (event.start.date + "T00:00:00Z");
      const end = event.end.dateTime || (event.end.date + "T23:59:59Z");
      const res = await gapi.client.calendar.events.list({
        calendarId: 'primary',
        timeMin: start,
        timeMax: end,
        singleEvents: true,
        orderBy: 'startTime'
      });
      return res.result.items.length > 0;
    }

    async function addEvent() {
      if (!accessToken) {
        alert("Log eerst in met Google.");
        return;
      }
      const kleuren = ["1","2","3","4","5","6","7","8","9","10","11"];
      const kleurSelect = document.getElementById("kleur");
      const gekozen = kleurSelect.value === "random" ? kleuren[Math.floor(Math.random() * kleuren.length)] : kleurSelect.value;
      const text = document.getElementById("inputText").value;
      const event = parseTextToEvent(text);
      if (!event) return;
      event.colorId = gekozen;
      const conflict = await checkConflict(event);
      if (conflict && !confirm("Er is al iets gepland op deze dag. Toch toevoegen?")) return;
      try {
        const request = gapi.client.calendar.events.insert({ calendarId: 'primary', resource: event });
        await request.execute();
        alert("Event toegevoegd!");
      } catch (error) {
        console.error(error);
        alert("Fout bij toevoegen van event.");
      }
    }
  </script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <label for="kleur">Kies kleur:</label>
  <select id="kleur">
    <option value="random" selected>ğŸ² Willekeurig</option>
    <option value="11">â¤ï¸ Rood (Tomaat)</option>
    <option value="6">ğŸŸ§ Oranje (Mandarijn)</option>
    <option value="5">ğŸ’› Geel (Zonnebloem)</option>
    <option value="10">ğŸ’š Donkergroen (Basilicum)</option>
    <option value="2">ğŸ’š Lichtgroen (Salie)</option>
    <option value="9">ğŸ’™ Blauw (Pauw)</option>
    <option value="7">ğŸ« Bosbes</option>
    <option value="3">ğŸ’œ Lavendel</option>
    <option value="4">ğŸ‡ Paars (Druif)</option>
    <option value="1">ğŸ’— Roze (Flamingo)</option>
    <option value="8">âš« Grijs (Grafiet)</option>
  </select>

  <label for="duur">Kies duur:</label>
  <select id="duur">
    <option value="60" selected>â± 1 uur</option>
    <option value="30">ğŸ•§ 30 minuten</option>
    <option value="45">ğŸ• 45 minuten</option>
    <option value="90">ğŸ•œ 1,5 uur</option>
    <option value="120">ğŸ•‘ 2 uur</option>
  </select>

  <label><input type="checkbox" id="heleDag"> Hele dag</label>
  <button id="herkenButton">ğŸ” Herken gegevens</button>
  <button id="voegToeButton">ğŸ“… Voeg toe aan agenda</button>

  <div id="output"></div>
  <div id="meerdereOutput"></div>

  
</body>
</html>